"\\GaR_Data\\robustness\\forecast_results_0.rds"))
head(temp)
temp %>%
slice(1) %>%
pull(gar_forecast)
temp %>%
slice(1) %>%
unnest()
temp %>%
slice(1) %>%
unnest(partition)
temp %>%
slice(1)
temp %>%
slice(1) %>%
unnest(gar_forecast)
temp %>%
unnest(gar_forecast)
temp %>%
slice(1:2) %>%
unnest(gar_forecast)
# Chunk 1: load_libraries
devtools::load_all()
library(furrr)
temp = read_rds(paste0("C:\\Users\\Home",
"\\OneDrive - Bank Of Israel\\Data\\BoI",
"\\GaR_Data\\robustness\\forecast_results_0.rds"))
raw_df = import_from_fame_template(
paste0("C:\\Users\\U095",
"\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data",
"\\robustness\\data_GaR_20220904.csv")) %>%
rename_all(tolower)
raw_df = raw_df %>%
select(-starts_with("staff"), -starts_with("dsge"))
raw_df = raw_df %>%
filter(date >= as.yearqtr("2000 Q1") & date <= as.yearqtr("2022 Q2"))
raw_df = import_from_fame_template(
paste0(Sys.getenv("USERPROFILE"),
"\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data",
"\\robustness\\data_GaR_20220904.csv")) %>%
rename_all(tolower)
raw_df = raw_df %>%
select(-starts_with("staff"), -starts_with("dsge"))
raw_df = raw_df %>%
filter(date >= as.yearqtr("2000 Q1") & date <= as.yearqtr("2022 Q2"))
temp %>%
slice(1:2) %>%
unnest(gar_forecast)
temp
temp %>%
slice(1:2) %>%
mutate(id = unlist(partition)) %>%
select(id, partition)
temp %>%
slice(1:2) %>%
mutate(id = map_chr(partition, unlist)) %>%
select(id, partition)
temp %>%
slice(1) %>%
pull(partition)
temp %>%
slice(1) %>%
pull(partition) %>%
unlist()
temp %>%
slice(1) %>%
pull(partition) %>%
unlist() %>%
paste0()
temp %>%
slice(1) %>%
pull(partition) %>%
unlist() %>%
paste0(,collapse = "")
temp %>%
slice(1) %>%
pull(partition) %>%
unlist() %>%
paste0(.,collapse = "")
temp %>%
slice(1) %>%
pull(partition) %>%
unlist() %>%
paste0(.,collapse = "-")
temp %>%
slice(1) %>%
mutate(id = paste0(unlist(partition), collapse = "-"))
unnest(gar_forecast)
temp %>%
slice(1:2) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast)
temp %>%
slice(1:2) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
count(id)
temp %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
count(id)
temp %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
filter(quantile == 0.1) %>%
count(id)
temp %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
filter(quantile == 0.1) %>%
filter(horizon == 12) %>%
count(id)
categories_list = list(
dom_macro = list(
required = c("gdp_yoy"),
optional = c(
"unemployment_diff",
"cpi_israel_yoy"
)),
dom_fin = list(
required = c(
"credit_yoy",
"house_price_yoy",
"ta125_close_yoy",
"boi_rate_diff"
),
optional = c(
"spread_cpi_corp",
"sovereigh_spread",
"term_spread",
"ils_usd_impl_vol",
"ta_35_impl_vol"
)),
ext_macro = list(
required = c(
"gdp_us_yoy",
"gdp_euro_yoy"
),
optional = c(
"cpi_us_yoy",
"infl_euro_4_ma",
"ind_prod_us_yoy",
"ind_prod_euro_yoy",
"oecd_imp"
)),
ext_fin = list(
required = c(
"rate_euro_diff",
"rate_us_diff"
),
optional = c(
"eurostoxx600",
"sp500",
"us_term_spread",
"dxy_yoy",
"oil_p_yoy",
"non_energy_p_yoy"
)
)
)
category_params_df =  categories_list%>%
enframe(name = "category", value = "params") %>%
mutate(part_comb_df = map2(category, params,
function(temp_name, temp_part) {
temp_part_df = get_partition_combs(partitions_list = temp_part,
partition_name = temp_name)
}))
feature_select_df = map(
category_params_df$category,function(temp_cat){
temp_df = category_params_df %>%
filter(category == temp_cat) %>%
select(part_comb_df) %>%
unnest(cols = c(part_comb_df))
return(temp_df)
}
) %>%
reduce(full_join, by = character()) %>%
unite(col = name,starts_with("name"),sep = "-") %>%
mutate(partition = pmap(list(dom_macro,dom_fin,ext_macro,ext_fin),c))
feature_select_df %>%
select(partition) %>% slice(1:2)
feature_select_df %>%
select(partition) %>%
slice(1)
feature_select_df %>%
select(partition) %>%
slice(1) %>%
unlist() %>%
paste(., collapse = "-")
temp_part = feature_select_df %>%
select(partition) %>%
slice(1) %>%
unlist() %>%
paste(., collapse = "-")
temp %>%
slice(1) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
pull(id)
temp %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
select(id) %>%
distinct() %>%
nrow()
temp %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
select(id) %>%
count()
temp %>%
slice(1:2) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
pull(id)
rm(temp_part)
str_a = temp %>%
slice(1) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
pull(id)
str_b = temp %>%
slice(2) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
pull(id)
setdiff(str_a, str_b)
str_b
str_a
setdiff("A-B-C-d", "A-B")
identical(str_a, str_b)
setdiff("C-d", "A-B")
?setdiff()
setdiff(1:3, 3:5)
setdiff("C-dA-B", "A-B")
setdiff("C-d-A-B", "A-B")
str_remove(str_a, str_a)
str_remove(str_a, str_b)
nchar(str_a)
nchar(str_b)
str_remove(str_a, "unemployment_diff")
str_remove(str_a, "unemployment_diff-cpi_israel_yoy-gdp_yoy-spread_cpi_corp-sovereigh_spread-term_spread-ils_usd_impl_vol-ta_35_impl_vol-credit_yoy-house_price_yoy-ta125_close_yoy-boi_rate_diff-cpi_us_yoy-infl_euro_4_ma-ind_prod_us_yoy-gdp_us_yoy-gdp_euro_yoy-eurostoxx600-oil_p_yoy-non_energy_p_yoy-rate_euro_diff-rate_us_diff")
nchar("unemployment_diff-cpi_israel_yoy-gdp_yoy-spread_cpi_corp-sovereigh_spread-term_spread-ils_usd_impl_vol-ta_35_impl_vol-credit_yoy-house_price_yoy-ta125_close_yoy-boi_rate_diff-cpi_us_yoy-infl_euro_4_ma-ind_prod_us_yoy-gdp_us_yoy-gdp_euro_yoy-eurostoxx600-oil_p_yoy-non_energy_p_yoy-rate_euro_diff-rate_us_diff")
str_b
str_a
temp %>%
slice(1)
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast)
temp %>%
slice(1) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
dim()
temp %>%
slice(1:2) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
dim
temp %>%
slice(1:2) %>%
mutate(id = paste0(unlist(partition), collapse = "-")) %>%
unnest(gar_forecast) %>%
group_by(id) %>%
summarise(temp = length(quantile))
temp %>%
slice(1:2) %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
unnest(gar_forecast) %>%
group_by(id) %>%
summarise(temp = length(quantile))
?quantile_r2_score()
raw_df %>%
select(date, gdp)
raw_df %>%
select(date, gdp) %>%
preprocess_df(vars_to_yoy = "gdp")
raw_df %>%
preprocess_df(vars_to_yoy = "gdp") %>%
select(date, gdp_yoy)
actual_df = raw_df %>%
preprocess_df(vars_to_yoy = "gdp") %>%
select(date, gdp_yoy) %>%
filter(complete.cases(.))
head(actual_df)
benchmark_df = get_gar_forecast(partitions_list = temp_part,
vars_df = raw_df %>%
preprocess_df(vars_to_yoy = "gdp"),
target_var_name = "gdp_yoy",
horizon_list = c(12),
quantile_vec = c(0.1,0.25,0.5,0.75,0.95))
benchmark_df = get_gar_forecast(partitions_list = NULL,
vars_df = raw_df %>%
preprocess_df(vars_to_yoy = "gdp"),
target_var_name = "gdp_yoy",
horizon_list = c(12),
quantile_vec = c(0.1,0.25,0.5,0.75,0.95))
temp %>%
slice(1) %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
unnest(gar_forecast)
temp %>%
slice(1) %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
unnest(gar_forecast) %>%
quantile_r2_score(actual_df = actual_df,benchmark_df = benchmark_df)
browser()
temp %>%
slice(1) %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
browser()
}))
head(temp_forecast_df)
global_actual_df = raw_df %>%
preprocess_df(vars_to_yoy = "gdp") %>%
select(date, gdp_yoy) %>%
filter(complete.cases(.))
global_benchmark_df = get_gar_forecast(partitions_list = NULL,
vars_df = raw_df %>%
preprocess_df(vars_to_yoy = "gdp"),
target_var_name = "gdp_yoy",
horizon_list = c(12),
quantile_vec = c(0.1,0.25,0.5,0.75,0.95))
temp_res = temp %>%
slice(1) %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
}))
View(temp_res)
temp_res %>%
select(id, r2_score) %>%
unnest(r2)
temp_res %>%
select(id, r2_score) %>%
unnest(r2_score)
temp_res = temp %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
})) %>%
select(id, r2_score) %>%
unnest(r2_score)
head(temp)
head(temp_res)
temp_res = temp %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
})) %>%
select(partition, id, r2_score) %>%
unnest(r2_score)
rm(temp_res)
extract_r2_score_from_df = function(temp_df){
temp_r2_score_df = temp_df %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
})) %>%
select(partition, id, r2_score) %>%
unnest(r2_score)
return(temp_r2_score_df)
}
temp_res = extract_r2_score_from_df(temp)
list_of_file_paths = list.files(paste0(Sys.getenv("USERPROFILE"),
"\\OneDrive - Bank Of Israel\\Data\\BoI",
"\\GaR_Data\\robustness"),
pattern = ".rds")
list_of_file_paths[1:2]
temp_res = map_dfr(list_of_file_paths[1:2], extract_r2_score_from_df)
list_of_file_paths[1:2]
list_of_file_paths = list.files(paste0(Sys.getenv("USERPROFILE"),
"\\OneDrive - Bank Of Israel\\Data\\BoI",
"\\GaR_Data\\robustness"),
pattern = ".rds",full.names = TRUE)
list_of_file_paths[1:2]
extract_r2_score_from_df = function(temp_file_path){
temp_df = read_rds(temp_file_path)
temp_r2_score_df = temp_df %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
})) %>%
select(partition, id, r2_score) %>%
unnest(r2_score)
rm(temp_df)
return(temp_r2_score_df)
}
temp_res = map_dfr(list_of_file_paths[1:2], extract_r2_score_from_df)
?tryCatch()
5*153
head(temp_res)
args(quantile_pit_score)
extract_scores_from_df = function(temp_file_path){
temp_df = read_rds(temp_file_path)
temp_r2_score_df = temp_df %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
})) %>%
mutate(pit_score = map(gar_forecast, function(temp_forecast_df){
pit_score = quantile_pit_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df)
return(pit_score)
})) %>%
select(partition, id, r2_score, pit_score)
browser()
temp_r2_score_df = temp_r2_score_df%>%
unnest(r2_score)
browser()
rm(temp_df)
return(temp_r2_score_df)
}
scores_df = map_dfr(list_of_file_paths[1:2], extract_scores_from_df)
temp_r2_score_df %>%
slice(1:2)
temp_r2_score_df %>%
slice(1) %>%
unnest(cols = c("r2_score","pit_score"))
temp_r2_score_df %>%
slice(1) %>%
unnest(cols = r2_score)
full_join(temp_r2_score_df %>%
slice(1) %>%
unnest(cols = r2_score),
temp_r2_score_df %>%
slice(1) %>%
unnest(cols = pit_score))
full_join(temp_r2_score_df %>%
slice(1:2) %>%
unnest(cols = r2_score),
temp_r2_score_df %>%
slice(1:2) %>%
unnest(cols = pit_score),
by = c("partition", "id", "horizon", "quantile"))
full_join(temp_r2_score_df %>%
slice(1:2) %>%
unnest(cols = r2_score),
temp_r2_score_df %>%
slice(1:2) %>%
unnest(cols = pit_score),
by = c("partition", "id", "horizon", "quantile")) %>%
select(-c("pit_score","r2_score"))
extract_scores_from_df = function(temp_file_path){
temp_df = read_rds(temp_file_path)
temp_scores_df = temp_df %>%
mutate(id = map_chr(partition,function(temp_str){
return(paste0(unlist(temp_str), collapse = "-"))
})) %>%
mutate(r2_score = map(gar_forecast, function(temp_forecast_df){
r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df,
benchmark_df = global_benchmark_df)
return(r2_score)
})) %>%
mutate(pit_score = map(gar_forecast, function(temp_forecast_df){
pit_score = quantile_pit_score(forecast_df = temp_forecast_df,
actual_df = global_actual_df)
return(pit_score)
})) %>%
select(partition, id, r2_score, pit_score)
temp_scores_df = full_join(temp_scores_df %>%
unnest(cols = r2_score),
temp_scores_df %>%
unnest(cols = pit_score),
by = c("partition", "id", "horizon", "quantile")) %>%
select(-c("pit_score","r2_score"))
rm(temp_df)
return(temp_scores_df)
}
scores_df = map_dfr(list_of_file_paths[1:2], extract_scores_from_df)
head(scores_df)
scores_df %>%
count(id)
write_csv(scores_df, paste0(Sys.getenv("USERPROFILE"),
"\\OneDrive - Bank Of Israel\\Data\\BoI",
"\\GaR_Data\\robustness\\scores.csv"))
