data = temp_df) %>%
coefficients() %>%
t() %>%
as.data.frame() %>%
rownames_to_column() %>%
mutate(rowname = str_remove_all(rowname, "tau= ")) %>%
rename(quantile = rowname,
int = `(Intercept)`,
slope = beir5y5y)
ggplot() +
geom_point(data = temp_df,
aes(x = beir5y5y, y = cpi_yoy_12)) +
geom_abline(data =  temp_qreq,
aes(intercept = int,
slope = slope,
color = quantile)) +
scale_color_manual(values = c("red","black","green")) +
xlim(c(1,3.5)) +
# ylim(c(-6,7)) +
xlab("Inflation long-term expectations") +
ylab("Inflation one year ahead") +
ggtitle("Realized inflation one year ahead")
# Chunk 10: plot_coeffs
coeff_df = iar_analysis %>%
extract_coeffs_from_gar_model() %>%
filter(!partition == "Intercept") %>%
filter(horizon == 12) %>%
select(-horizon) %>%
mutate(partition = factor(partition,
levels = c("cpi_yoy","beir5y5y" ,
"meshulav_gap","brent_usd_percent_change",
"nis_usd_percent_change"),
labels = c("Inflation","Expectations","Output Gap",
"Oil prices","Exchange Rate")
))
ggplot() +
geom_col(data = coeff_df, aes(x = quantile, y = coeff,
fill = significant),
width = 0.3) +
scale_fill_manual(values = c("significant" = "lightblue",
"non_significant" = "gray"),
labels = c("Significant", "Non significant")) +
facet_wrap(~partition, scales = "free") +
geom_hline(data = ols_coeffs,
aes(yintercept = estimate,linetype = "OLS"),
color = "blue") +
scale_linetype_manual(values = "dashed") +
geom_hline(yintercept = 0, color = "black") +
xlab("Quantile") + ylab(NULL) +
labs(
caption = paste0(
"Notes: Each column shows the estimated coefficients ",
"from the quantile regression. ",
"\n  Blue bars mark coefficients that are significant at 10%",
"(see Koenker, 1994)"
)
) +
theme(plot.caption = element_text(size = 10, hjust = 0.5),
axis.text.x = element_text(size = 12),
strip.text = element_text(size = 12))
# Chunk 11: plot_dist_timeseries
iar_analysis$fitted_df %>%
filter(horizon == 12) %>%
group_by(date = as.yearqtr(date), quantile) %>%
summarise(avg_values = mean(fitted_values),
.groups = "drop") %>%
pivot_wider(names_from = "quantile",
names_prefix = "q_",
values_from = "avg_values") %>%
ggplot(aes(x = date)) +
geom_ribbon(aes(ymin = q_0.25, ymax = q_0.75,
fill = "50% of the distribution"),
alpha = 0.5) +
geom_line(aes(y = q_0.5, color = "Median")) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1,
scale = 1)) +
scale_fill_manual(values = c("50% of the distribution" = "grey")) +
scale_color_manual(values = c("Median" = "black")) +
guides(color = guide_legend(order = 1),
fill = guide_legend(order = 2)) +
ylab(NULL) + xlab(NULL)  +
ggtitle(paste0("Predicted annual inflation one year",
" ahead (quarterly averages)"))
# Chunk 12: plot_skewness_1_quarter
n = nrow(df)
skew_se=sqrt( 6*n*(n-1) / ((n-2)*(n+1)*(n+3)) )
skew_df = iqr_df %>%
filter(horizon == 12) %>%
select(-horizon) %>%
pivot_longer(-date) %>%
# group_by(date = as.yearqtr(date), name) %>%
# summarise(value = mean(value), .groups = "drop") %>%
mutate(name = factor(name, levels = c("iqr","skew"),
labels = c("Dispersion","Skewness")))
hline_df = skew_df %>%
group_by(name) %>%
summarise(val = mean(value)) %>%
mutate(color = "blue") %>%
mutate(linetype = "solid") %>%
bind_rows(tibble(name = rep("Skewness",2),
val = c(2 * skew_se, -2 * skew_se),
color = "black",
linetype = "dashed")) %>%
bind_rows(tibble(name = "Skewness",
val = 0,
color = "black",
linetype = "solid"))
skew_df%>%
ggplot(aes(x = date, y = value)) +
geom_line() +
facet_wrap(~name, scales = "free") +
geom_hline(aes(yintercept = val, color = color, linetype = linetype),
data = hline_df, show.legend = FALSE) +
scale_color_manual(values = c("black" = "black","blue" = "blue")) +
scale_linetype_manual(values = c("solid" = "solid",
"dashed" = "dashed")) +
labs(x = "", y = "",
caption = paste0("Note: the dashed lines represent",
" ± 2 standard error estimates")) +
theme(plot.caption = element_text(hjust = 0.5))
rm(skew_df, hline_df, skew_se, n)
# Chunk 13: factor_decomposition_deviations
means_vec = iqr_df %>%
filter(horizon == 12) %>%
select(skew,iqr) %>%
summarise(across(everything(), mean))
median_mean = iar_analysis$fitted_df %>%
filter(quantile == "0.5") %>%
pull(fitted_values) %>%
mean()
labels_df = tibble(level = c("cpi_yoy","nis_usd_percent_change",
"brent_usd_percent_change",
"meshulav_gap","exp_int"),
label = c("Inflation","Exchange Rate",
"Oil prices","Output Gap",
"Exp. and Intercept"))
factors_cont_df = iar_analysis %>%
extract_factor_contribution_from_gar_model(target_quantile = "0.25") %>%
mutate(quantile = 0.25) %>%
bind_rows(iar_analysis %>%
extract_factor_contribution_from_gar_model(target_quantile = "0.75") %>%
mutate(quantile = 0.75)) %>%
bind_rows(iar_analysis %>%
extract_factor_contribution_from_gar_model(target_quantile = "0.5") %>%
mutate(quantile = 0.5)) %>%
filter(horizon == 12) %>%
# filter(date >= as.yearmon("Jan 2007")) %>%
pivot_longer(-c(date, quantile, horizon))
skew_plot_df = factors_cont_df %>%
pivot_wider(id_cols = c(date,name, horizon), names_from = quantile,
names_prefix = "q_") %>%
left_join(iqr_df, by = c("date", "horizon")) %>%
mutate(skew_cont = (q_0.75 + q_0.25 - 2 * q_0.5) / iqr) %>%
select(-starts_with("q_"),-horizon,-iqr) %>%
group_by(date = as.yearqtr(date), name) %>%
summarise(across(everything(),mean, na.rm = TRUE), .groups = "drop")  %>%
pivot_wider(names_from = name, values_from = skew_cont) %>%
mutate(exp_int = intercept + beir5y5y - means_vec$skew) %>%
mutate(skew = skew - means_vec$skew) %>%
select(-c(intercept,beir5y5y)) %>%
pivot_longer(-c(date,skew)) %>%
mutate(name = factor(name,levels = labels_df$level,
labels = labels_df$label))
disp_plot_df = factors_cont_df %>%
pivot_wider(id_cols = c(date,name, horizon), names_from = quantile,
names_prefix = "q_") %>%
left_join(iqr_df, by = c("date", "horizon")) %>%
mutate(iqr_cont = q_0.75 - q_0.25) %>%
select(-starts_with("q_"),-horizon,-skew) %>%
group_by(date = as.yearqtr(date), name) %>%
summarise(across(everything(),mean, na.rm = TRUE), .groups = "drop")  %>%
pivot_wider(names_from = name, values_from = iqr_cont) %>%
mutate(exp_int = intercept + beir5y5y - means_vec$iqr) %>%
mutate(iqr = iqr - means_vec$iqr) %>%
select(-c("intercept","beir5y5y")) %>%
pivot_longer(-c(date,iqr)) %>%
mutate(name = factor(name,levels = labels_df$level,
labels = labels_df$label))
median_plot_df = factors_cont_df %>%
pivot_wider(id_cols = c(date,name, horizon), names_from = quantile,
names_prefix = "q_") %>%
mutate(med_cont = q_0.5) %>%
select(-starts_with("q_"),-horizon) %>%
group_by(date = as.yearqtr(date), name) %>%
summarise(across(everything(),mean, na.rm = TRUE), .groups = "drop")  %>%
pivot_wider(names_from = name, values_from = med_cont) %>%
mutate(exp_int = intercept + beir5y5y - median_mean) %>%
select(-c("intercept","beir5y5y")) %>%
pivot_longer(-c(date)) %>%
mutate(name = factor(name,levels = labels_df$level,
labels = labels_df$label))
# Chunk 14: plot_factor_decomposition
skew_plot = ggplot() +
geom_col(aes(x = date, y = value, fill = name),
data = skew_plot_df) +
geom_line(aes(x = date, y = skew),
data = skew_plot_df, size = 1) +
xlab(NULL) + ylab(NULL) + ggtitle("Skewness")
disp_plot =  ggplot() +
geom_col(aes(x = date, y = value, fill = name),
data = disp_plot_df) +
geom_line(aes(x = date, y = iqr),
data = disp_plot_df, size = 1) +
xlab(NULL) + ylab(NULL) + ggtitle("Dispersion")
med_plot =  ggplot() +
geom_col(aes(x = date, y = value, fill = name),
data = median_plot_df) +
geom_line(aes(x = date, y = value),
data = median_plot_df %>%
group_by(date) %>%
summarise(value = sum(value), .groups = "drop"),
size = 1) +
xlab(NULL) + ylab(NULL) + ggtitle("Median") +
labs(caption = "Deviations from the mean (quarterly average)")
plot_legend = get_legend(disp_plot)
plots_row = plot_grid(disp_plot +
theme(legend.position = "none"),
skew_plot +
theme(legend.position = "none"),
med_plot +
theme(legend.position = "none",
plot.caption = element_text(hjust = 0)))
plot_grid(plots_row, plot_legend,nrow = 2,rel_heights = c(4,1))
# Chunk 16: inflation_iqr
iqr_df %>%
filter(horizon == 12) %>%
left_join(select(df, c(date, cpi_yoy)), by = "date") %>%
left_join(iar_analysis$fitted_df %>%
filter(quantile == 0.5) %>%
select(date, horizon, median = fitted_values)) %>%
pivot_longer(cols = c(skew,iqr,median)) %>%
mutate(name = factor(name, levels = c("median", "iqr","skew"),
labels = c("Median","Dispersion","Skewness"))) %>%
ggplot(aes(x = cpi_yoy, y = value)) +
geom_point() +
geom_smooth(method = "lm") +
facet_wrap(~name, scales = "free") +
scale_x_continuous(labels = scales::percent_format(scale = 1,
accuracy = 1)) +
xlab("Realized inflation") + ylab(NULL)
# Chunk 17: expectation_iqr
iqr_df %>%
filter(horizon == 12) %>%
left_join(select(df, c(date, beir5y5y)), by = "date") %>%
left_join(iar_analysis$fitted_df %>%
filter(quantile == 0.5) %>%
select(date, horizon, median = fitted_values)) %>%
pivot_longer(cols = c(skew,iqr,median)) %>%
mutate(name = factor(name, levels = c("median", "iqr","skew"),
labels = c("Median","Dispersion","Skewness"))) %>%
ggplot(aes(x = beir5y5y, y = value)) +
geom_point() +
geom_smooth(method = "lm") +
facet_wrap(~name, scales = "free") +
scale_x_continuous(labels = scales::percent_format(scale = 1,
accuracy = 0.1)) +
xlab("Inflation expectations") + ylab(NULL) +
theme(axis.text.x = element_text(hjust = 0.25))
# Chunk 18: oil_gap_iqr
iqr_df %>%
filter(horizon == 12) %>%
left_join(select(df, c(date, x = brent_nis))) %>%
left_join(iar_analysis$fitted_df %>%
filter(quantile == 0.5) %>%
select(date, horizon, median = fitted_values)) %>%
pivot_longer(cols = c(skew,iqr,median)) %>%
mutate(name = factor(name, levels = c("median", "iqr","skew"),
labels = c("Median","Dispersion","Skewness"))) %>%
ggplot(aes(x = x, y = value)) +
geom_point() +
geom_smooth(method = "lm") +
facet_wrap(~name, scales = "free") +
scale_x_continuous(labels = scales::percent_format(scale = 1)) +
xlab("Oil price") + ylab(NULL)
ggplot() +
geom_ribbon(
data = iar_forecast %>%
filter(horizon == 12) %>%
filter(quantile %in% c("0.10", "0.90")) %>%
mutate(date = date + as.numeric(horizon)  / 12) %>%
pivot_wider(
names_from = "quantile",
names_prefix = "q_",
values_from = "forecast_values"
),
aes(
x = date,
ymin = q_0.10,
ymax = q_0.90,
fill = "80% of Distribution"
),
alpha = 0.5) +
geom_ribbon(
data = iar_forecast %>%
filter(quantile %in% c(0.25, 0.75)) %>%
filter(horizon == 12) %>%
mutate(date = date + as.numeric(horizon)  / 12) %>%
pivot_wider(
names_from = "quantile",
names_prefix = "q_",
values_from = "forecast_values"
),
aes(
x = date,
ymin = q_0.25,
ymax = q_0.75,
fill = "50% of Distribution"
),
alpha = 0.8) +
geom_line(
data = iar_forecast %>%
filter(quantile == "0.50") %>%
filter(horizon == 12) %>%
mutate(date = date + as.numeric(horizon)  / 12),
aes(x = date, y = forecast_values,
color = "Forecasted Median 12 Month Earlier")
) +
geom_line(
data = df %>%
filter(
date >= iar_forecast %>%
filter(horizon == 12) %>%
pull(date) %>% min() + 1
),
aes(x = date, y = cpi_yoy, color = "Realized Inflation")
) +
ylab("Percent") + xlab(NULL) +
ggtitle("Quantiles of inflation") +
scale_fill_manual(values = c("grey","lightblue")) +
scale_color_manual(values = c("black","red")) +
theme(legend.text = element_text(size = 12))
iar_forecast %>%
filter(horizon == 12)
ggplot() +
geom_ribbon(
data = iar_forecast %>%
filter(horizon == 12) %>%
filter(quantile %in% c("0.1", "0.9")) %>%
mutate(date = date + as.numeric(horizon)  / 12) %>%
pivot_wider(
names_from = "quantile",
names_prefix = "q_",
values_from = "forecast_values"
),
aes(
x = date,
ymin = q_0.10,
ymax = q_0.90,
fill = "80% of Distribution"
),
alpha = 0.5) +
geom_ribbon(
data = iar_forecast %>%
filter(quantile %in% c(0.25, 0.75)) %>%
filter(horizon == 12) %>%
mutate(date = date + as.numeric(horizon)  / 12) %>%
pivot_wider(
names_from = "quantile",
names_prefix = "q_",
values_from = "forecast_values"
),
aes(
x = date,
ymin = q_0.25,
ymax = q_0.75,
fill = "50% of Distribution"
),
alpha = 0.8) +
geom_line(
data = iar_forecast %>%
filter(quantile == "0.50") %>%
filter(horizon == 12) %>%
mutate(date = date + as.numeric(horizon)  / 12),
aes(x = date, y = forecast_values,
color = "Forecasted Median 12 Month Earlier")
) +
geom_line(
data = df %>%
filter(
date >= iar_forecast %>%
filter(horizon == 12) %>%
pull(date) %>% min() + 1
),
aes(x = date, y = cpi_yoy, color = "Realized Inflation")
) +
ylab("Percent") + xlab(NULL) +
ggtitle("Quantiles of inflation") +
scale_fill_manual(values = c("grey","lightblue")) +
scale_color_manual(values = c("black","red")) +
theme(legend.text = element_text(size = 12))
ggplot() +
geom_ribbon(
data = iar_forecast %>%
filter(horizon == 12) %>%
filter(quantile %in% c("0.1", "0.9")) %>%
mutate(date = date + as.numeric(horizon)  / 12) %>%
pivot_wider(
names_from = "quantile",
names_prefix = "q_",
values_from = "forecast_values"
),
aes(
x = date,
ymin = q_0.1,
ymax = q_0.9,
fill = "80% of Distribution"
),
alpha = 0.5) +
geom_ribbon(
data = iar_forecast %>%
filter(quantile %in% c(0.25, 0.75)) %>%
filter(horizon == 12) %>%
mutate(date = date + as.numeric(horizon)  / 12) %>%
pivot_wider(
names_from = "quantile",
names_prefix = "q_",
values_from = "forecast_values"
),
aes(
x = date,
ymin = q_0.25,
ymax = q_0.75,
fill = "50% of Distribution"
),
alpha = 0.8) +
geom_line(
data = iar_forecast %>%
filter(quantile == "0.5") %>%
filter(horizon == 12) %>%
mutate(date = date + as.numeric(horizon)  / 12),
aes(x = date, y = forecast_values,
color = "Forecasted Median 12 Month Earlier")
) +
geom_line(
data = df %>%
filter(
date >= iar_forecast %>%
filter(horizon == 12) %>%
pull(date) %>% min() + 1
),
aes(x = date, y = cpi_yoy, color = "Realized Inflation")
) +
ylab("Percent") + xlab(NULL) +
ggtitle("Quantiles of inflation") +
scale_fill_manual(values = c("grey","lightblue")) +
scale_color_manual(values = c("black","red")) +
theme(legend.text = element_text(size = 12))
iar_pit = quantile_pit_score(
forecast_df = iar_forecast %>%
filter(horizon == 12),
actual_df = select(df, actual_values = cpi_yoy, date)) %>%
rename(iar = pit)
intercept_pit = quantile_pit_score(
forecast_df = intercept_forecast  %>%
filter(horizon == 12),
actual_df = select(df, actual_values = cpi_yoy, date)) %>%
rename(intercept = pit)
inflation_pit = quantile_pit_score(
forecast_df = inflation_forecast %>%
filter(horizon == 12),
actual_df = select(df, actual_values = cpi_yoy, date)) %>%
rename(realized_inflation = pit)
list(iar_pit, intercept_pit, inflation_pit) %>%
reduce(inner_join, by = c("quantile", "horizon")) %>%
pivot_longer(-c("quantile", "horizon")) %>%
mutate(quantile = as.numeric(quantile)) %>%
mutate(name = factor(name,
levels = c("realized_inflation","iar",
"intercept"),
labels = c("CPI only",
"Inflation at risk",
"Intercept"))) %>%
ggplot(aes(x = quantile,y = value,color = name,group = name)) +
geom_line() +
geom_abline(
slope = 1,
intercept = 0,
color = "black",
linetype = "dashed"
) +
xlim(0,1) + ylim(0,1) +
xlab("Quantile") + ylab(NULL)
iqr_df %>%
filter(horizon == 12) %>%
left_join(select(df, c(date, x = meshulav_gap)), by = "date") %>%
left_join(iar_analysis$fitted_df %>%
filter(quantile == 0.5) %>%
select(date, horizon, median = fitted_values)) %>%
pivot_longer(cols = c(skew,iqr,median)) %>%
mutate(name = factor(name, levels = c("median", "iqr","skew"),
labels = c("Median","Dispersion","Skewness"))) %>%
ggplot(aes(x = x, y = value)) +
geom_point() +
geom_smooth(method = "lm") +
facet_wrap(~name, scales = "free") +
xlab("Output gap") + ylab(NULL)
iqr_df %>%
filter(horizon == 12) %>%
left_join(select(df, c(date, x = nis_usd))) %>%
left_join(iar_analysis$fitted_df %>%
filter(quantile == 0.5) %>%
select(date, horizon, median = fitted_values)) %>%
pivot_longer(cols = c(skew,iqr,median)) %>%
mutate(name = factor(name, levels = c("median", "iqr","skew"),
labels = c("Median","Dispersion","Skewness"))) %>%
ggplot(aes(x = x, y = value)) +
geom_point() +
geom_smooth(method = "lm") +
facet_wrap(~name, scales = "free") +
scale_x_continuous(labels = scales::percent_format(scale = 1,accuracy = 1)) +
xlab("Exchange rate") + ylab(NULL) +
theme(axis.text.x = element_text(hjust = 0.25))
