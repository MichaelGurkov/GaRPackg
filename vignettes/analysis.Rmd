---
title: "Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">
  body{
  font-size: 14pt;
}
</style>


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = TRUE,
  comment = "#>", warning = FALSE, message = FALSE
)
```

This vignette demonstrates the use of the "workhorse" function of the package  - `run_GaR_analysis`.
This function takes the (transformed) data, performs dimension reduction (if required), runs quantile regression and returns several objects

First we'll load necessary variables and import our dataset


```{r setup}

library(GaRPackg)

library(dplyr)

library(zoo)

```

```{r import_process_data}

data("gar_data")

gar_data = gar_data %>% 
  select("date", "gdp","ind_prod_israel","credit","house_price")  %>%
  mutate(date = as.yearqtr(date)) 


```


The required arguments for `run_GaR_analysis` are:

 - A list of groups of features in order to perform dimension
 reduction (the default method is PCA)
 - A list of forecast horizons
 - A list of distribution quantiles.

Now we define those as parameters (in order to feed them to the function). For educational purposes two groups (each including two features) are defined: 

 - Macro group that includes GDP and Industrial production index
 - Financial group that includes credit and house price features. 
 
The forecasting will be done at one quarter and one year (four quarters) horizon with three quantiles (5%, 50%, 95%) estimated.

In this setting a more appropriate approach would be to transform the variables
(we'll you Year on Year transformation, for more details see [preprocessing vignette](preprocessing.html)). In order to reference the transformed
variables to the analysis function we'll add "_yoy" suffix to the names of the
variables



```{r, echo=TRUE}

partitions_list = list(
  macro = c("gdp_yoy", "ind_prod_israel_yoy"),
  fin = c("credit_yoy", "house_price_yoy")
)

horizon_list = c(1,4)

quantile_vec = c(0.05,0.5,0.95)

```

Now we transform the features to "year on year" changes. This can also be done as a step in the workflow using %>% operator rather than as a separate step.

```{r preprocess_data}

df = gar_data %>%
  preprocess_df(vars_to_yoy = c("gdp","ind_prod_israel","credit","house_price"))

```

Now we are ready to feed the inputs to `run_GaR_analysis`

```{r run_analysis}

result = run_GaR_analysis(partitions_list = partitions_list,
                          vars_df = df,
                          target_var_name = "gdp_yoy",
                          horizon_list = horizon_list,
                          quantile_vec = quantile_vec)

```


`run_GaR_analysis` returns several useful objects that can be used
to evaluate and investigate results. The returned objects are:

 - Data frame with quantile regression data (`reg_df`)
 - Quantile regression model results for each horizon (`qreg_result`)
 - Fitted values for each regression (`fitted_df`)
 - List of feature groups (partitions) (`partitions_list`)
 - List of PCA objects including components and loadings (`pca_obj`)

```{r print_results}
names(result)
```

