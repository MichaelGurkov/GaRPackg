
```{r load_libraries}

library(tidyverse)

devtools::load_all()

```

```{r Import_data}

raw_df = import_from_fame_template(
  paste0(Sys.getenv("USERPROFILE"),
         "\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data",
         "\\robustness\\data_GaR_20220904.csv")) %>% 
  rename_all(tolower)

raw_df = raw_df %>% 
  select(-starts_with("staff"), -starts_with("dsge"))

raw_df = raw_df %>% 
  filter(date >= as.yearqtr("2000 Q1") & date <= as.yearqtr("2022 Q2"))

```


```{r set_params}

categories_list = list(
  dom_macro = list(
    required = c("gdp_yoy"),
    optional = c(
      "unemployment_diff",
      "cpi_israel_yoy"
    )),
  dom_fin = list(
    required = c(
      "credit_yoy",
      "house_price_yoy",
      "ta125_close_yoy",
      "boi_rate_diff"
      ),
    optional = c(
      "spread_cpi_corp",
      "ils_usd_spread_pct",
      "interbank_spread",
      "sovereigh_spread",
      "term_spread",
      "ils_usd_impl_vol",
      "ta_35_impl_vol"
    )),
  ext_macro = list(
    required = c(
      "gdp_us_yoy",
      "gdp_euro_yoy"
      ), 
      optional = c(
        "cpi_us_yoy",
        "infl_euro_4_ma",
        "ind_prod_us_yoy",
        "ind_prod_euro_yoy",
        "oecd_imp"
      )),
  ext_fin = list(
    required = c(
      "rate_euro_diff",
      "rate_us_diff"
      ),
      optional = c(
        "eurostoxx600",
        "sp500",
        "us_term_spread",
        "dxy_yoy",
        "oil_p_yoy",
        "non_energy_p_yoy"
      )
    )
)

```

```{r get_all_combinations_test}


category_params_df =  categories_list%>%
  enframe(name = "category", value = "params") %>%
  mutate(part_comb_df = map2(category, params,
                             function(temp_name, temp_part) {
                               temp_part_df = get_partition_combs(partitions_list = temp_part,
                                                                  partition_name = temp_name)
                             }))


feature_select_df = map(
  category_params_df$category,function(temp_cat){
    temp_df = category_params_df %>% 
      filter(category == temp_cat) %>% 
      select(part_comb_df) %>% 
      unnest(cols = c(part_comb_df))
    return(temp_df)
                        }
  ) %>% 
  reduce(full_join, by = character()) %>% 
  unite(col = name,starts_with("name"),sep = "-") %>% 
  mutate(partition = pmap(list(dom_macro,dom_fin,ext_macro,ext_fin),c))

rm(category_params_df)

```

```{r run_forecast}

tictoc::tic()

numCores = parallel::detectCores() - 1 

cl = parallel::makeCluster(numCores)

doParallel::registerDoParallel(cl)


forecast_results = feature_select_df %>% 
select(partition) %>% 
slice(1) %>% 
mutate(gar_forecast = map(partition, function(temp_part){


temp_res = get_gar_forecast(partitions_list = temp_part,
                                vars_df = raw_df,
                                target_var_name = "gdp_yoy",
                                horizon_list = c(1,4,8,12),
                                quantile_vec = c(0.1,0.25,0.5,0.75,0.95))

return(temp_res)



}))

tictoc::toc()
```
