
```{r load_libraries}

library(tidyverse)

devtools::load_all()

library(furrr)

```


```{r Import_data}

raw_df = import_from_fame_template(
  paste0(Sys.getenv("USERPROFILE"),
         "\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data",
         "\\robustness\\data_GaR_20220904.csv")) %>% 
  rename_all(tolower)

raw_df = raw_df %>% 
  select(-starts_with("staff"), -starts_with("dsge"))

raw_df = raw_df %>% 
  filter(date >= as.yearqtr("2000 Q1") & date <= as.yearqtr("2022 Q2"))

```


```{r get_all_combinations_test}

categories_list = list(
  dom_macro = list(
    required = c("gdp_yoy"),
    optional = c(
      "unemployment_diff",
      "cpi_israel_yoy"
    )),
  dom_fin = list(
    required = c(
      "credit_yoy",
      "house_price_yoy",
      "ta125_close_yoy",
      "boi_rate_diff"
      ),
    optional = c(
      "spread_cpi_corp",
      "sovereigh_spread",
      "term_spread",
      "ils_usd_impl_vol",
      "ta_35_impl_vol"
    )),
  ext_macro = list(
    required = c(
      "gdp_us_yoy",
      "gdp_euro_yoy"
      ), 
      optional = c(
        "cpi_us_yoy",
        "infl_euro_4_ma",
        "ind_prod_us_yoy",
        "ind_prod_euro_yoy",
        "oecd_imp"
      )),
  ext_fin = list(
    required = c(
      "rate_euro_diff",
      "rate_us_diff"
      ),
      optional = c(
        "eurostoxx600",
        "sp500",
        "us_term_spread",
        "dxy_yoy",
        "oil_p_yoy",
        "non_energy_p_yoy"
      )
    )
)
 

category_params_df =  categories_list%>%
  enframe(name = "category", value = "params") %>%
  mutate(part_comb_df = map2(category, params,
                             function(temp_name, temp_part) {
                               temp_part_df = get_partition_combs(partitions_list = temp_part,
                                                                  partition_name = temp_name)
                             }))


feature_select_df = map(
  category_params_df$category,function(temp_cat){
    temp_df = category_params_df %>% 
      filter(category == temp_cat) %>% 
      select(part_comb_df) %>% 
      unnest(cols = c(part_comb_df))
    return(temp_df)
                        }
  ) %>% 
  reduce(full_join, by = character()) %>% 
  unite(col = name,starts_with("name"),sep = "-") %>% 
  mutate(partition = pmap(list(dom_macro,dom_fin,ext_macro,ext_fin),c))

```


```{r run_forecast}

set.seed(132)

sample_vec = sample(1:nrow(feature_select_df),size = 100000)

dir_path = paste0(Sys.getenv("USERPROFILE"),
                  "\\OneDrive - Bank Of Israel\\Data",
                  "\\BoI\\GaR_Data\\robustness\\")

for (i in 0:100){
  
  print(i)
  
  ind_low = i * 1000
  
  ind_high = (i + 1) * 1000
  
  sample_ind = sample_vec[ind_low:ind_high]
  
  forecast_results = feature_select_df %>% 
  select(partition) %>% 
  slice(sample_ind) %>% 
  mutate(gar_forecast = map(partition, function(temp_part){
  vars_to_yoy = temp_part %>% 
    unlist() %>% 
    str_subset(pattern = "_yoy") %>% 
    str_remove_all(pattern = "_yoy")
  
  
  vars_to_diff = temp_part %>% 
    unlist() %>% 
    str_subset(pattern = "_diff") %>% 
    str_remove_all(pattern = "_diff")
  
  vars_to_ma = temp_part %>% 
    unlist() %>% 
    str_subset(pattern = "_4_ma") %>% 
    str_remove_all(pattern = "_4_ma")
  
  
  processed_df = raw_df %>% 
    preprocess_df(vars_to_yoy = vars_to_yoy,
                  vars_to_diff = vars_to_diff,
                  vars_to_4_ma = vars_to_ma) %>% 
    select("date","gdp_yoy",all_of(unlist(temp_part,use.names = FALSE))) %>% 
    filter(complete.cases(.))
  
  
  temp_res = get_gar_forecast(partitions_list = temp_part,
                                  vars_df = processed_df,
                                  target_var_name = "gdp_yoy",
                                  horizon_list = c(12),
                                  quantile_vec = c(0.1,0.25,0.5,0.75,0.95))
  
  return(temp_res)
 
  
  
  }))
  
  write_rds(forecast_results,file = paste0(dir_path,
                                           "forecast_results_",i,".rds"))
  
  
}


```

```{r get_evaluation_scores}

global_actual_df = raw_df %>% 
  preprocess_df(vars_to_yoy = "gdp") %>% 
  select(date, gdp_yoy) %>% 
  filter(complete.cases(.))


global_benchmark_df = get_gar_forecast(partitions_list = NULL,
                                  vars_df = raw_df %>% 
                                  preprocess_df(vars_to_yoy = "gdp"),
                                  target_var_name = "gdp_yoy",
                                  horizon_list = c(12),
                                  quantile_vec = c(0.1,0.25,0.5,0.75,0.95))

list_of_file_paths = list.files(paste0(Sys.getenv("USERPROFILE"),
                                       "\\OneDrive - Bank Of Israel\\Data\\BoI",
                                       "\\GaR_Data\\robustness"),
                                pattern = ".rds",full.names = TRUE)


extract_scores_from_df = function(temp_file_path){
  
  temp_df = read_rds(temp_file_path)
  
  temp_scores_df = temp_df %>% 
    mutate(id = map_chr(partition,function(temp_str){
    
    return(paste0(unlist(temp_str), collapse = "-"))
    
  })) %>% 
    mutate(r2_score = map(gar_forecast, function(temp_forecast_df){

    r2_score = quantile_r2_score(forecast_df = temp_forecast_df,
                                 actual_df = global_actual_df,
                                 benchmark_df = global_benchmark_df)
    
    return(r2_score)
    
    
  })) %>% 
    mutate(pit_score = map(gar_forecast, function(temp_forecast_df){

    pit_score = quantile_pit_score(forecast_df = temp_forecast_df,
                                   actual_df = global_actual_df)
    
    return(pit_score)
    
    
  })) %>% 
    select(partition, id, r2_score, pit_score) 
  
  temp_scores_df = full_join(temp_scores_df %>% 
                                 unnest(cols = r2_score),
                               temp_scores_df %>% 
                                 unnest(cols = pit_score),
                               by = c("partition", "id", "horizon", "quantile")) %>% 
    select(-c("pit_score","r2_score"))
  

  rm(temp_df)

return(temp_scores_df)

  
}


scores_df = map_dfr(list_of_file_paths, extract_scores_from_df)

write_csv(scores_df, paste0(Sys.getenv("USERPROFILE"),
                            "\\OneDrive - Bank Of Israel\\Data\\BoI",
                            "\\GaR_Data\\robustness\\scores.csv"))


```

```{r sample_check, eval=FALSE}

temp_ind = 1000

temp_part = feature_select_df %>% 
  select(partition) %>% 
  mutate(id = map_chr(partition,~paste0(unlist(.), collapse = "-"))) %>% 
  filter(id == scores_df$id[temp_ind])

temp_part = temp_part$partition[[1]]

  temp_vars_to_yoy = temp_part %>% 
      unlist() %>% 
      str_subset(pattern = "_yoy") %>% 
      str_remove_all(pattern = "_yoy")
    
    
  temp_vars_to_diff = temp_part %>% 
    unlist() %>% 
    str_subset(pattern = "_diff") %>% 
    str_remove_all(pattern = "_diff")
  
  temp_vars_to_ma = temp_part %>% 
    unlist() %>% 
    str_subset(pattern = "_4_ma") %>% 
    str_remove_all(pattern = "_4_ma")
  
  temp_processed_df = raw_df %>% 
      preprocess_df(vars_to_yoy = temp_vars_to_yoy,
                    vars_to_diff = temp_vars_to_diff,
                    vars_to_4_ma = temp_vars_to_ma) %>% 
      select("date","gdp_yoy",all_of(unlist(temp_part,use.names = FALSE))) %>% 
      filter(complete.cases(.))
  
  temp_forecast_df = get_gar_forecast(partitions_list = temp_part,
                                    vars_df = temp_processed_df,
                                    target_var_name = "gdp_yoy",
                                    horizon_list = c(12),
                                    quantile_vec = c(0.1,0.25,0.5,0.75,0.95))
  
  temp_r2 = quantile_r2_score(forecast_df = temp_forecast_df,
                              actual_df = global_actual_df,
                              benchmark_df = global_benchmark_df)
  
  benchmark_r2 = scores_df %>% 
    filter(id == id[temp_ind]) %>% 
    select(horizon, quantile, quantile_r2)
  

  print(all.equal(temp_r2, benchmark_r2))
  
rm(list = ls(pattern = "temp"), benchmark_r2, ind_vec)


```

```{r analyze_evaluation_scores}

scores_df = read_csv(paste0(Sys.getenv("USERPROFILE"),
                            "\\OneDrive - Bank Of Israel\\Data\\BoI",
                            "\\GaR_Data\\robustness\\scores_a.csv"),
                     show_col_types = FALSE) %>% 
  select(-partition)


best_models = scores_df %>% 
  group_by(quantile) %>% 
  mutate(best_model_ind = if_else(quantile_r2 >= quantile(quantile_r2,0.95),
                                  1,0)) %>% 
  ungroup() %>% 
  group_by(id) %>% 
  summarise(best_model_total = sum(best_model_ind)) %>% 
  filter(best_model_total == 5)

best_models %>% 
  select(id) %>% 
  mutate(len_id = nchar(id)) %>% 
  count(len_id)

```

