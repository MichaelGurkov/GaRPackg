---
title: "Inflation at Risk: The Distribution of Future Inflation in Israel"
author: "Michael Gurkov and Osnat Zohar"
institute: "Bank of Israel \\newline Research Department \\newline \\newline Any views expressed in the Discussion Paper are those of the authors and do not necessarily reflect those of the Bank of Israel"
date: "16 June, 2021"
classoption: t
output:
  beamer_presentation:
    includes:
      in_header: !expr here::here('vignettes/GaR-PresentationPreamble.tex')
    latex_engine: xelatex
    slide_level: 2
# bibliography: "GaR.bib"
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,
  warning = FALSE, comment = "#>"

)
```


```{r init_setup}

devtools::load_all()

library(GaRPackg)

library(mFilter)

library(tidyverse)

library(lubridate)

library(slider)

library(cowplot)

library(broom)

library(gghighlight)

setwd(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
  "\\Documents\\GaRPackg\\vignettes"))


```


```{r set_params}

partitions_list = list(
  inflation = c("cpi"),
  exchange_rate = c("nis_usd"),
  oil_p = c("brent_usd"),
  output_gap = c("meshulav_hpcyc")
)



horizon_list=c(12)

quantile_vec=c(0.10,0.25,0.5,0.75,0.90)



theme_set(theme_bw() + 
            theme(title = element_text(size = 20),
                axis.text = element_text(size = 15),
                axis.title = element_text(size = 15),
                strip.text = element_text(size = 15),
                legend.position = "bottom",
                legend.title = element_blank(),
                legend.text = element_text(size = 15)))

# plot_names = tribble(
#   ~var_name, ~plot_name,
#   "Intercept", "Intercept",
#   "cpi", "Inflation",
#   "cpi_lag", "Inflation",
#   "spf1y","Expectations",
#   "beir5y5y","LT Expect.",
#   "nis_usd", "Exchange Rate",
#   "rel_tradables", "Tradables",
#   "brent_usd", "Oil Prices",
#   "meshulav_hpcyc","Output Gap"
# )



```

```{r load_data}

raw_df = import_from_fame_template(
  paste0(
    file.path(Sys.getenv("USERPROFILE")),
    "\\OneDrive - Bank Of Israel\\Data\\BoI\\IaR_data\\data_Inflation_at_Risk_monthly.csv"
  ),data_frequency = "monthly"
)

df = raw_df %>% 
  mutate(rel_tradables = cpi_tradables / cpi_nontradables_excl_fv_hous) %>%
  preprocess_df(
    vars_to_yoy = c(
      "cpi",
      "cpi_excl_fv",
      "cpi_excl_fv_hous",
      "cpi_excl_hous",
      "rel_tradables",
      "cpi_oecd",
      "cpi_us",
      "cpi_euro",
      "debt_business",
      "debt_households",
      "house_price",
      "ta125"
    ),
    vars_to_percent_changes = c("nis_usd",
                                "neer",
                                "brent_usd",
                                "brent_nis",
                                "non_energy_p"),
    convert_to_percent_units = TRUE
  ) %>%
  mutate(target = target * 100) %>% 
  mutate(cpi_orig = cpi) %>% 
  mutate(cpi = cpi_excl_fv_hous) %>% 
  mutate(cpi_lag = lag(cpi)) %>% 
  filter(year(date) >= 2004 & year(date) <= 2019) %>% 
  mutate(meshulav_hpcyc = hpfilter(madad_meshulav,freq = 1600)$cycle)



```

```{r run_analysis}

iar_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df,
  target_var_name = "cpi",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(
    output_gap = list("output_gap", TRUE),
    expect = list("beir1y", TRUE)
  )
)

ols_coeffs = iar_analysis$reg_df %>% 
  select(cpi_12, ends_with("xreg")) %>% 
  lm("cpi_12 ~ .",.) %>% 
  tidy() %>% 
  filter(!term == "(Intercept)") %>% 
  mutate(term = str_remove_all(term, "_xreg")) %>% 
  mutate(partition = factor(term,
                       levels = c("nis_usd","cpi","brent_usd","meshulav_hpcyc"),
                       labels = c("Exchange Rate","Inflation","Oil prices",
                                       "Output Gap"))) %>% 
  select(partition, estimate)


```

```{r out_of_sample_forecast, eval=FALSE}

iar_forecast = get_gar_forecast(partitions_list = partitions_list,
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = 96,
                                win_type_expanding = TRUE)

intercept_forecast = get_gar_forecast(partitions_list = NULL,
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = 96,
                                win_type_expanding = TRUE)

inflation_forecast = get_gar_forecast(partitions_list = list(inflation = "cpi"),
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = 96,
                                win_type_expanding = TRUE)




```


## Outline

\tableofcontents[sectionstyle=show/show,subsectionstyle=hide/hide]

## Motivation

\begin {itemize}
\itemsep3em
	\item
	Assessing risks to future economic activity is essential for making knowledgeable forecasts.
	\item
	An important factor: financial vulnerabilities.
	\item
	We provide a methodological tool for assessing risks to growth in Israel using real and financial variables:

	\vspace{1em}

\begin{center}
\begin{block}{}

	Given current macro-financial conditions, what is the distribution of
	expected economic growth?

\end{block}
\end{center}

\end{itemize}


## Motivation

```{r plot_inf_rates}

df %>% 
  select(date, cpi) %>% 
  mutate(cpi_ma = slide_dbl(cpi,mean,.before = 48,.complete = TRUE)) %>% 
  mutate(cpi_var = slide_dbl(cpi,var,.before = 48,.complete = TRUE)) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, color = name)) + 
  geom_line() + 
  scale_color_discrete(labels = c("CPI Inflation","CPI Moving Average (48 periods)",
                                "CPI Variance (48 periods)")) + 
  xlab(NULL) + ylab(NULL) + 
  ggtitle(paste0("Year-on-Year CPI Inflation Excluding Fruits,",
                 " Vegetables, and Housing (Monthly,2004-2019)"))


```

## The Growth at Risk (GaR) Approach

\vspace{1em}

* GaR is a linear model of density forecasts
  + Based on quantile regression
  + Parsimonious
  + Easy to interpret

\vspace{1em}

* Proposed by Adrian et al. (2019), operationalized by the IMF (Prasad et al., 2019).

\vspace{1em}

* Applied to:
  + Advanced economies (Aikman et al., 2018, 2019; Alessandri et al., 2019)
  + Developing economies (Komatsuzaki and Brito, 2019; Bespalova and Rousset,	2019)


## Contribution

\vspace{3em}

\begin{itemize}
  \setlength\itemsep{3em}
  \item
  Tools for regular assessment of risks:
  \begin{itemize}
    \item
    5th percentile of forecast
    \item
    State-dependent fan charts
  \end{itemize}
  \item
  Improve understanding of macro-financial linkages in Israel:
  \begin{itemize}
    \item
    Provide empirical evidence to support macro-financial modeling
  \end{itemize}
\end{itemize}


## Main Results

\begin{itemize}
\setlength\itemsep{1.5em}
\item
In-sample properties of the distribution of expected GDP growth:
  \begin{enumerate}
	\item
	\textbf{Symmetric} -- upside and downside risks are balanced.
	\item
	\textbf{Forecast uncertainty} rises when the median forecast decreases.
	\item
	\textbf{Financial Vulnerabilities} -- accomodative financial conditions contribute to
	        medium term risks to growth.
  \end{enumerate}
\item
These properties are robust to variable selection.
\item
Out-of-sample forecast performance in distribution tails is similar to benchmark models.

  \begin{itemize}
    \item but GaR allows state-dependent evaluation of risks
  \end{itemize}
  
\end{itemize}






# Methodology and Estimation Results
## Methodology


\label{methodology}

(IMF: Prasad et al., 2019)
\begin{enumerate}
	\item
	\textbf{Partition data:} divide a large number of variables
	into $K$ groups ($K$ small).
	\item
	\textbf{Dimension reduction} to alleviate overfitting:
	\begin{itemize}
		\item
		From each group $k\in\{1,...,K\}$, generate a single
		regressor $x^k_t$
		\item
		Method: first principal component
	\end{itemize}
	\item
	\textbf{Quantile regressions --}
	estimate a forecast equation for each quantile $\tau$
	and horizon $h$:
	$$
	Q^{\tau}_{t,h}=\beta^{\tau}_hX_t+\epsilon^{\tau}_{t,h}
	$$

	\vspace{0.5em}

	where $ X_t=[1, x^1_t, ... , x^K_t]$
	\vspace{1em}
	\begin{flushright}
		\hyperlink{QuantileReg}{\beamerbutton{quantile reg}}
	\end{flushright}
\end{enumerate}



## Data Partitioning

\label{DataPartitioning}

Sample: 1996Q1-2019Q4

<!-- \flushleft -->

\vspace{1em}

\scriptsize

\begin{tabular}{cccc}

  \vspace{2em}

		\textbf{Domestic Macro} & \textbf{Domestic Financial Cond.} &
		\textbf{External Macro}	& \textbf{External Financial Cond.} \\


	\vspace{1em}


		Private consumption & BOI rate & Exports & Federal Funds rate \\

	\vspace{1em}

		Real Investment & Private credit & Imports & Eonia \\

	\vspace{1em}

		Public consumption & House price index & OECD imports & SP500 \\

	\vspace{1em}

		Unemployment & TA125 &  & Eurostoxx600 \\

	\vspace{1em}

		&  &  & Brent oil price \\

	\vspace{1em}

		&  &  & Non energy commodity \\

	\vspace{1em}

\end{tabular}

\vspace{1em}

\flushright

\hyperlink{PcaLoadings}{\beamergotobutton{PCA loadings}}

\vspace{-1em}

\flushleft

\hyperlink{PcaTimeseries}{\beamergotobutton{PCA time-series}}




## Persistent inflation, positive factor and negative output gap

\label{Coeffs}

```{r plot_coeffs, fig.height=6.5}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  mutate(partition = factor(partition,
                            levels = c("nis_usd","cpi","brent_usd","meshulav_hpcyc"),
                            labels = c("Exchange Rate","Inflation","Oil prices",
                                       "Output Gap"))) %>%
  ggplot(aes(x = quantile, y = coeff, fill = significant)) +
  geom_col(width = 0.3) +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_grid(rows = vars(partition), scales = "free") +
  geom_hline(aes(yintercept = estimate), data = ols_coeffs,
             color = "blue", linetype = "dashed") +
  geom_hline(yintercept = 0) + 
  xlab("Quantile") + ylab(NULL) + 
  labs(caption = paste0("Notes: Each column shows the estimated coefficients ",
                        "from the quantile regression at a specific forecast horizon. ",
                        "\n  Blue bars mark coefficients that are significant at 10%",
                        "(see Koenker, 1994)"),
       title = "Sample: 1996Q1-2019Q4") +
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12)) + 
  # theme_classic() +
  NULL

```

\vspace{-1em}

\flushleft


\hyperlink{CoeffPanel}{\beamergotobutton{Coefficients Panel}}


# In-sample Properties of Risks to Growth
## 5th Percentile Forecast

```{r plot_fan}

plot_df = iar_analysis$fitted_df %>%
  filter(quantile %in% c(0.25,0.5,0.75)) %>% 
  select(-horizon) %>% 
  group_by(date = as.yearqtr(date), quantile) %>% 
  summarise(avg_values = mean(fitted_values), .groups = "drop")

ggplot() + 
  geom_line(data = plot_df %>%
              filter(quantile == "0.5"), aes(x = date, y = avg_values)) +
  geom_ribbon(data = plot_df %>%
                filter(quantile %in% c(0.25,0.75)) %>%
                pivot_wider(names_from = "quantile",
                            names_prefix = "q_",
                            values_from = "avg_values"),
              aes(x = date, ymin = q_0.25, ymax = q_0.75), alpha = 0.5) +
  ylab("Percent") + xlab(NULL) +
  ggtitle("Forecast of 5th Percentile, 1Q and 12Q Ahead")
 

```


## Risks to Growth are generally balanced
Contrary to other countries **no evidence of skewed distribution**

```{r plot_skewness_1_quarter, fig.height=6}

skew_df = iar_analysis %>%
  calculate_skew_and_iqr() %>%
  select(-horizon) %>% 
  pivot_longer(-date) %>% 
  group_by(date = as.yearqtr(date), name) %>% 
  summarise(value = mean(value), .groups = "drop") %>% 
  mutate(name = factor(name, levels = c("iqr","skew"),
                       labels = c("Dispersion","Skewness")))

mean_df = skew_df %>% 
  group_by(name) %>% 
  summarise(avg = mean(value))

 skew_df%>% 
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  # geom_hline(aes(yintercept = mean(value)), color = "blue") + 
  facet_wrap(~name, scales = "free") + 
  geom_hline(aes(yintercept = avg), color = "blue", data = mean_df) + 
  # geom_hline(yintercept = c(-0.5,0.5), linetype = "dashed",
  #            color = "blue") +
  # geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(x = "", y = "", title = "High Moments of the Forecast Distribution",
       caption = "Note: the dashed lines represent Â± 2 standard error estimates") + 
  theme(plot.caption = element_text(hjust = 0.5))

 
 rm(skew_df, mean_df)

```


## Global factors contribute to risk identification in the short term, domestic financial factors -- in the long term

```{r plot_factor_decomposition, eval=FALSE}


factor_plot_data = iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.25") %>%
  mutate(quantile = 0.25) %>% 
  bind_rows(iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.75") %>%
  mutate(quantile = 0.75)) %>% 
  bind_rows(iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.5") %>%
  mutate(quantile = 0.5)) %>% 
  select(-horizon) %>% 
  pivot_longer(-c(date,quantile)) %>% 
  filter(!name == "intercept") %>% 
  pivot_wider(names_from = quantile,names_prefix = "q_") %>% 
  mutate(dispersion = q_0.75 - q_0.25) %>% 
  mutate(skewness = q_0.75 + q_0.25 - 2 * q_0.5) %>% 
  mutate(name = factor(name,
                       levels = c("cpi","nis_usd","brent_usd","meshulav_hpcyc"),
                       labels = c("Inflation","Exchange Rate","Oil prices",
                                  "Output Gap")))


factor_plot_data %>% 
  ggplot(aes(x = date, y = dispersion, fill = name)) + 
  geom_col()

factor_plot_data %>% 
  ggplot(aes(x = date, y = skewness, fill = name)) + 
  geom_col()


```


```{r factors_figure, out.height="85%"}

knitr::include_graphics("Figures/GaR_factor_all.png")


```




## Low Median Forecasts are Associated with Higher Uncertainty

```{r plot_median_iqr_scatter, eval=FALSE}

iar_analysis %>%
  calculate_skew_and_iqr() %>%
  inner_join(iar_analysis$fitted_df %>%
               filter(quantile == "0.5") %>%
               select(-quantile), by = c("date","horizon")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = iqr, y = fitted_values)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Dispersion") + ylab("Median") +
  theme(axis.text = element_text(size = 8))


```


```{r med_variance_figure, out.height="85%"}

knitr::include_graphics("Figures/fig_MedianVarCorr.png")


```



# Out-of-Sample Forecast Performance
## Out-of-Sample Forecast Performance

\vspace{2em}

\begin{itemize}
\setlength\itemsep{2em}
	\item
	GaR model compared to two alternatives:
	\begin{enumerate}
		\item
		Intercep only -- partial GaR model without financial variables
		(domestic and global)
		\item
		DSGE model (Argov et al., 2012), fan chart (symmetric, constant width).
		\textcolor{blue}{DSGE model was reestimated in 2019 so it's prediction are "in sample"}
	\end{enumerate}
	\item
	The models are evaluated out of sample (expanding window starts at
	40 observations and adds one observation in each step)
\end{itemize}

## Goodness of fit -- PIT score \newline (the closer to the black line the better)

\label{PITscore}

```{r pit_score, eval=FALSE}

iar_pit = quantile_pit_score(
  forecast_df = iar_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = select(df, actual_values = cpi, date)) %>%
  rename(iar = pit)

intercept_pit = quantile_pit_score(
  forecast_df = intercept_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = select(df, actual_values = cpi, date)
) %>%
  rename(intercept = pit)

inflation_pit = quantile_pit_score(
  forecast_df = inflation_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = select(df, actual_values = cpi, date)
) %>%
  rename(realized_inflation = pit)

list(iar_pit, intercept_pit, inflation_pit) %>%
  reduce(inner_join, by = c("quantile", "horizon")) %>%
  pivot_longer(-c("quantile", "horizon")) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  ggplot(aes(x = quantile,y = value,color = name,group = name)) +
  geom_line(width = 0.5) +
  geom_abline(
    slope = 1,
    intercept = 0,
    color = "black",
    linetype = "dashed"
  ) +
  # scale_fill_discrete(labels = c("DSGE","GaR")) +
  xlab("Quantile") + ylab(NULL)



```


```{r pit_figure, out.height="80%"}

knitr::include_graphics("Figures/PIT.png")


```

\hyperlink{PIT}{\beamergotobutton{PIT}}

## Goodness of fit --Quantile R-Squared
Quantile R-sq. Giglio et al. (2016) compares forecast performance to a
intercept only quantile benchmark:

$$
R^2_{\tau,h} \equiv 1- \frac{\sum_{t} \left( y_{t+h} - \hat{Q}^{\tau}_{t,h} \right) \left(\tau - \mathbb{I}_{ \left\{ y_{t+h} - \hat{Q}^{\tau}_{t,h}>0 \right\} } \right) }{ \sum_{t} \left(y_{t+h} - \hat{c}^{\tau}_{t,h} \right) \left(\tau - \mathbb{I}_{ \left\{ y_{t+h} - \hat{Q}^{\tau}_{t,h}>0 \right\} } \right) }
$$

$\hat{Q}^{\tau}_{t,h}$  -- model's forecasts for quantile
$\tau$ at horizon $h$

$\hat{c}^{\tau}_{t,h}$ -- intercept only forecast


\begin{itemize}
	\item
	higher values -- better forecast
	\item
	negative values -- model inferior to the intercept only benchmark
\end{itemize}




## Goodness of fit --Quantile R-Squared \newline (the higher the better, negative means worse than intercept only)

```{r plot_r2_score, eval=FALSE}

gar_r2 = quantile_r2_score(
  forecast_df = gar_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = df %>% 
    filter(date) < as.yearqtr("2019 Q4") %>% 
    select(date, actual_values = gdp),
  benchmark_df = intercept_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25) %>%
    rename(benchmark_values = forecast_values)
) %>%
  rename(gar_r2 = quantile_r2)

dsge_r2 = quantile_r2_score(
  forecast_df = dsge_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25) %>%
    rename(forecast_values = forecast),
  actual_df = df %>% 
    filter(date) < as.yearqtr("2019 Q4") %>% 
    select(date, actual_values = gdp),
  benchmark_df = intercept_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25) %>%
    rename(benchmark_values = forecast_values)
  ) %>%
  rename(dsge_r2 = quantile_r2)

gar_r2 %>%
  inner_join(dsge_r2,by = c("horizon", "quantile")) %>%
  pivot_longer(-c(horizon, quantile)) %>%
  mutate(quantile = factor(quantile, levels = quantile_vec)) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = quantile, y = value, fill = name)) +
  geom_col(position = "dodge") +
  scale_fill_discrete(labels = c("DSGE","GaR")) +
  facet_wrap(~horizon) +
  xlab("Quantile") + ylab(NULL)

```


```{r r2_figure, out.height="85%"}

knitr::include_graphics("Figures/R2.png")


```


# Summary

\begin{itemize}
\setlength\itemsep{2em}

  \item
  Growth distribution in Israel is "balanced" and unskewed
  \item
  Global conditions affect downside risks in the short term, local financial
  conditions in the long term.
  \item
  Evidence of "volatility paradox" - loose financial conditions stimulate
  growth in the near term and risk accumulation in the long term.
  \item
  Forecast uncertainty rises when the median forecast decreases
  
  
\end{itemize}


## Current uses

```{r left_tail}

current_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2021 Q1")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))


current_analysis$fitted_df %>%
  filter(horizon %in% c(1, 4)) %>%
  filter(quantile == "0.05") %>%
  ggplot(aes(x = date, y = fitted_values, color = horizon)) +
  geom_line() + 
  ylab(NULL) + xlab(NULL) +
  scale_y_continuous(labels = scales::percent_format()) +
  ggtitle("Forecast of 5th Percentile, 1Q and 4Q Ahead")

```

## Current uses

```{r fan_chart_2019_4}

fan_forecast_df = get_gar_forecast(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2019 Q4")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))

fan_forecast_df %>% 
  plot_fan_chart(realized_df = df %>% 
                   select(date, gdp),
                 fan_chart_date = as.yearqtr("2019 Q4")) + 
  ggtitle("Fan chart at 2019 Q4")



```

## Current uses

```{r fan_chart_2020_4}

fan_forecast_df = get_gar_forecast(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2020 Q4")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))

fan_forecast_df %>% 
  plot_fan_chart(realized_df = df %>% 
                   select(date, gdp),
                 fan_chart_date = as.yearqtr("2020 Q4")) + 
  ggtitle("Fan chart at 2020 Q4")



```


# Appendix {.unlisted .unnumbered}
## Short-Term Forecast of 5th Percentile More Volatile Than Long-Term Forecast


```{r events_figure, out.height="85%", eval=FALSE}

knitr::include_graphics("Figures/events_plot.png")


```
## Macro shows cyclical pattern (high growth in the short term, low in the long term)

\label{MacroCoef}

\label{selected_coeffs}

```{r dom_macro_plot, fig.height=6.5}


gar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition %in% c("dom_macro", "ext_macro")) %>%
  mutate(partition = recode(partition,
                            "dom_macro" = "Dom. Macro", "ext_macro" = "Ext. Macro")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = quantile, y = coeff, fill = significant)) +
  geom_col() +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_grid(cols = vars(horizon), rows = vars(partition), scales = "free") +
  xlab("Quantile") + ylab(NULL) + 
  labs(caption = paste0("Notes: Each column shows the estimated coefficients ",
                        "from the quantile regression at a specific forecast horizon. ",
                        "\n Blue bars mark coefficients that are significant at 10%",
                        "(see Koenker, 1994)"),
       title = "Sample: 1996Q1-2019Q4") + 
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12))




```



\vspace{-1em}

\flushleft

\hyperlink{coeffs_panel}{\beamergotobutton{Coefficients Panel}}


## Probability Integral Transform (PIT)

\label{PIT}


For each quantile $\tau$ and horizon $h$, we compute  the percentage of observations that fall below the forecast quantile $\hat{Q}^{\tau}_{t,h}$:
	$$
	\varphi_{\tau,h} \equiv \frac{1}{T-h} \sum_{t=1}^{T-h} \mathbb{I}_{ \left\{ y_{t+h} <  \hat{Q}^{\tau}_{t,h} \right\} }.
	$$
\begin{itemize}
\setlength\itemsep{1em}
	\item
	A model is better fitted the closer $\varphi_{\tau,h}$ is to
	45-degree line.
	\item
	If the model perfectly fits the empirical  distribution, then
	the fraction of observations falling below quantile $\tau$
	should be exactly $\tau$, namely, $\varphi_{\tau,h}=\tau$.
\end{itemize}


\hyperlink{PITscore}{\beamergotobutton{PITscore}}

## Quantile Regression

\label{QuantileReg}

Model: for quantile $\tau$ and horizon $h$,
$$
Q^{\tau}_{t,h}=\beta^{\tau}_hX_t+\epsilon^{\tau}_{h,t}
$$

$\beta^{\tau}$ is  estimated by solving the minimization problem

$$
\min_{\beta^{\tau}}
\sum_{t=1}^T
\max \bigg\{
\tau \big( y_{t+h}- \beta^{\tau}X_t \big)
\, ,\,
(\tau-1) \big( y_{t+h}- \beta^{\tau}X_t \big)
\bigg\}
$$

Note: "Quantile crossing" handled using the method of Chernozhukov et al. (2010).

\begin{flushleft}
\hyperlink{methodology}{\beamergotobutton{Methodology}}
\end{flushleft}



## 1st PC loadings

\label{PcaLoadings}


```{r plot_pc_loadings}

gar_analysis %>%
  extract_pca_loadings_from_gar_model() %>%
  mutate(partition = factor(
    partition,
    levels = c("dom_fin", "dom_macro","ext_fin",  "ext_macro"),
    labels = c("Dom. Fin. Cond", "Dom Macro", "Ext. Fin. Cond",  "Ext Macro"))) %>%
  mutate(rowname = str_to_title(rowname)) %>% 
  mutate(rowname = str_replace_all(rowname,"_"," ")) %>% 
  ggplot(aes(x = rowname, y = coeff)) +
  geom_col(width = 0.5) +
  facet_wrap( ~ partition, scales = "free") +
  theme(axis.text.x = element_text(size = 13)) +
  coord_flip() +
  xlab(NULL) + ylab(NULL)

```


\vspace{-0.5em}

\hyperlink{DataPartitioning}{\beamergotobutton{Data Partitioning}}


## Quantile Regression Coefficients


\label{CoeffPanel}

```{r coeff_panel_plot, fig.height=7}

gar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  mutate(partition = recode(partition,
                            "dom_macro" = "Dom. Macro",
                            "ext_macro" = "Ext. Macro",
                            "dom_fin" = "Dom. Fin. Cond.",
                            "ext_fin" = "Ext. Fin. Cond.")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = quantile, y = coeff, fill = significant)) +
  geom_col() +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_grid(cols = vars(horizon), rows = vars(partition), scales = "free") +
  xlab("Quantile") + ylab(NULL) + 
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),strip.text.y = element_text(size = 14))


```


\vspace{-0.5em}

\hyperlink{Coeffs}{\beamergotobutton{Coeffs}}


