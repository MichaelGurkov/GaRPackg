---
title: "Inflation Risks in Israel"
author: "Michael Gurkov and Osnat Zohar"
institute: "Bank of Israel \\newline Research Department \\newline \\newline Any views expressed in the Discussion Paper are those of the authors and do not necessarily reflect those of the Bank of Israel"
date: "27 July, 2021"
classoption: t
output:
  beamer_presentation:
    includes:
      in_header: !expr here::here('vignettes/GaR-PresentationPreamble.tex')
    latex_engine: xelatex
    slide_level: 2
# bibliography: "GaR.bib"
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,
  warning = FALSE, comment = "#>"

)
```


```{r init_setup}

devtools::load_all()

library(ggcorrplot)

library(mFilter)

library(tidyverse)

library(lubridate)

library(slider)

library(cowplot)

library(broom)

library(gghighlight)

library(glue)

setwd(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
  "\\Documents\\GaRPackg\\vignettes"))


```



```{r set_params}

partitions_list = list(
  inflation = c("cpi_yoy"),
  exchange_rate = c("nis_usd_percent_change"),
  oil_p = c("brent_usd_percent_change"),
  output_gap = c("meshulav_gap"),
  expectation = c("beir5y5y")
)



horizon_list=c(1,12)

quantile_vec=c(0.10,0.25,0.5,0.75,0.90)



theme_set(theme_bw() + 
            theme(title = element_text(size = 20),
                axis.text = element_text(size = 15),
                axis.title = element_text(size = 15),
                strip.text = element_text(size = 15),
                legend.position = "bottom",
                legend.title = element_blank(),
                legend.text = element_text(size = 15)))

labels_df = tibble(level = c("cpi_yoy","nis_usd_percent_change",
                             "brent_usd_percent_change",
                             "meshulav_gap","beir5y5y", "intercept"),
                   label = c("Inflation","Exchange Rate",
                             "Oil prices","Output Gap",
                             "Expectations","Intercept"))



```

```{r auxilary_functions}

calculate_disp_and_skew_contributons = function(iar_model){
  
  factor_contributions = map_dfr(
    list(
      "0.25" = 0.25,
      "0.5" = 0.5,
      "0.75" = 0.75
    ),
    extract_factor_contribution_from_gar_model,
    gar_model = iar_model,
    .id = "quantile"
  ) %>%
    pivot_longer(-c("date", "horizon", "quantile"),
                 names_to = "category",
                 values_to = "factor_contribution") %>%
    pivot_wider(
      id_cols = c("date", "horizon", "category"),
      names_from = "quantile",
      values_from = "factor_contribution",
      names_prefix = "q_"
    )
  
  factor_contributions = factor_contributions %>%
    inner_join(calculate_skew_and_iqr(iar_model),
               by = c("date", "horizon")) %>%
    filter(horizon == 12) %>%
    mutate(
      contribution_U = q_0.75 - q_0.5,
      contribution_D = q_0.5 - q_0.25,
      contribution_iqr = q_0.75 - q_0.25,
      contribution_skew = (contribution_U - contribution_D) / iqr
    ) %>%
    select(-c(contribution_U, contribution_D, starts_with("q_")))
  
  
  return(factor_contributions)
  
  
}

make_plot_df = function(factor_contributions, labels_df){
  

plot_df = factor_contributions %>%
  select(-c(skew, iqr)) %>%
  pivot_longer(
    cols = c(starts_with("contribution")),
    names_to = "facet",
    values_to = "contribution_value",
    names_prefix = "contribution_"
  ) %>%
  inner_join(
    factor_contributions %>%
      select(-starts_with("contribution")) %>%
      pivot_longer(
        cols = c(skew, iqr),
        names_to = "facet",
        values_to = "total_value"
      ),
    by = c("date", "category", "horizon", "facet")
  ) %>%
  group_by(category, facet, horizon) %>%
  mutate(across(contains("value"),
                ~ scale(., scale = FALSE)[, 1])) %>%
  ungroup() %>%
  mutate(category = factor(category, levels = labels_df$level,
                           labels = labels_df$label))

  return(plot_df)
  
  
}

```



```{r load_data}

raw_df = import_from_fame_template(
  paste0(file.path(Sys.getenv("USERPROFILE")),
    "\\OneDrive - Bank Of Israel\\Data\\BoI\\IaR_data",
    "\\data_Inflation_at_Risk_4InflationBook.csv"),
  data_frequency = "monthly"
)

df = raw_df %>% 
  mutate(rel_tradables = cpi_tradables /
           cpi_nontradables_excl_fv_hous) %>%
  preprocess_df(
    vars_to_yoy = c(
      "cpi",
      "cpi_excl_fv",
      "cpi_excl_fv_hous",
      "cpi_excl_hous",
      "rel_tradables",
      "cpi_oecd",
      "cpi_us",
      "cpi_euro",
      "debt_business",
      "debt_households",
      "house_price",
      "ta125"
    ),
    vars_to_percent_changes = c("nis_usd",
                                "neer",
                                "brent_usd",
                                "brent_nis",
                                "non_energy_p"),
    convert_to_percent_units = TRUE
  ) %>%
  mutate(target = target * 100) %>% 
  mutate(cpi_yoy_orig = cpi_yoy) %>% 
  mutate(cpi_yoy = cpi_excl_fv_hous_yoy) %>% 
  mutate(cpi_yoy_lag = lag(cpi_yoy)) %>% 
  filter(year(date) >= 2004 & year(date) <= 2019)


filter_obj =  hpfilter(df$madad_meshulav,freq = 1600)

df = df %>% 
  mutate(meshulav_gap = filter_obj$cycle / filter_obj$trend[,1] * 100)

df = df %>% 
  mutate(intercept_elb = if_else(date >= as.yearmon("Sep 2014") &
                         year(date) <= 2019,1,0)) %>% 
  mutate(across(unlist(partitions_list, use.names = FALSE),
                ~. * intercept_elb, .names = "{col}_elb"))


```

```{r run_analysis}

iar_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df,
  target_var_name = "cpi_yoy",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(
    output_gap = list("output_gap", TRUE),
    expectation = list("beir5y5y", TRUE)
  )
)

ols_coeffs = iar_analysis$reg_df %>%
  select(cpi_yoy_12, ends_with("xreg")) %>%
  lm(paste("cpi_yoy_12 ~ ."), .) %>%
  tidy() %>%
  filter(!term == "(Intercept)") %>%
  mutate(term = str_remove_all(term, "_xreg")) %>%
  mutate(partition = factor(
    term,
    levels = c(
      "cpi_yoy",
      "beir5y5y" ,
      "meshulav_gap",
      "brent_usd_percent_change",
      "nis_usd_percent_change"
    ),
    labels = c(
      "Inflation",
      "Expectations",
      "Output Gap",
      "Oil prices",
      "Exchange Rate"
    )
  )) %>%
  select(partition, estimate)


```

```{r iqr_df}

iqr_df = iar_analysis %>% 
  calculate_skew_and_iqr()

```


```{r run_robustness_elb}

partitions_list_elb = map(partitions_list, ~paste0(.,"elb"))

names(partitions_list_elb) = paste0(names(partitions_list), "elb")

iar_analysis_elb = run_GaR_analysis(
  partitions_list = c(partitions_list,partitions_list_elb,
                      "intercept_elb" = "intercept_elb"),
  vars_df = df,
  target_var_name = "cpi_yoy_elb",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(
    output_gap = list("output_gap_elb", TRUE),
    expectation = list("beir5y5y_elb", TRUE)
  )
)

```


```{r out_of_sample_forecast}

# win_len = df %>% 
#   select(date, unlist(partitions_list, use.names = FALSE)) %>% 
#   filter(year(date) <= 2015) %>% 
#   nrow()

win_len = 133

iar_forecast = get_gar_forecast(partitions_list = partitions_list,
                                vars_df = df,
                                target_var_name = "cpi_yoy",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

intercept_forecast = get_gar_forecast(partitions_list = NULL,
                                vars_df = df,
                                target_var_name = "cpi_yoy",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

inflation_forecast = get_gar_forecast(partitions_list = list(
  inflation = "cpi_yoy"),
                                vars_df = df,
                                target_var_name = "cpi_yoy",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

rm(win_len)


```


## Motivation



\begin{quote}

\small

"Monetary policy responded first in the summer of 2012 by acting to defuse the sovereign debt crisis, which had evolved from a \textbf{tail risk for inflation} into a material threat to price stability."

\vspace{1em}

Mario Draghi, ECB President, Sintra, June 2019

\end{quote}

\vspace{2em}

\begin {itemize}
\setlength\itemsep{1em}
	\item
	We analyze the distribution of future inflation since the current inflation target
	range was set.
	\item
	We provide a methodological tool for assessing risks to inflation in Israel
	using a Philips curve specification:


\begin{center}
\begin{block}{}

	Given current real and nominal conditions, what is the distribution of
	expected inflation?

\end{block}
\end{center}

\end{itemize}


## Motivation

```{r plot_inf_rates}

df %>%
  select(date, cpi_yoy) %>%
  mutate(cpi_ma = slide_dbl(cpi_yoy,
                            mean,.before = 48,.complete = TRUE)) %>%
  mutate(cpi_var = slide_dbl(cpi_yoy,
                             var,.before = 48,.complete = TRUE)) %>%
  pivot_longer(-date) %>%
  mutate(name = factor(name, levels = c("cpi_yoy",
                                        "cpi_ma",
                                        "cpi_var"))) %>% 
  ggplot(aes(x = date, y = value, color = name)) +
  geom_line() +
  scale_color_discrete(labels = c(
    "CPI Inflation",
    "CPI Inflation Moving Average (48 periods)",
    "CPI Inflation Variance (48 periods)")) +
  xlab(NULL) + ylab(NULL) +
  ggtitle(paste0("Year-on-Year CPI Inflation Excluding Fruits,",
                 " Vegetables, and Housing \n (Monthly,2004-2019)")) + 
  theme(plot.title = element_text(size = 17))


```

## Outline

\tableofcontents[sectionstyle=show/show,subsectionstyle=hide/hide]

## Quantile regression

```{r quantile_plot}

temp_df = df %>%
  select(cpi_yoy,beir5y5y) %>%
  add_leads_to_target_var("cpi_yoy",leads_vector = 12) %>%
  filter(complete.cases(.))


temp_qreq = rq(formula = formula("cpi_yoy_12 ~ beir5y5y"),
               tau = c(0.05,0.5,0.95),
               data = temp_df) %>%
  coefficients() %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  mutate(rowname = str_remove_all(rowname, "tau= ")) %>%
  rename(quantile = rowname,
         int = `(Intercept)`,
         slope = beir5y5y)



ggplot() +
  geom_point(data = temp_df,
             aes(x = beir5y5y, y = cpi_yoy_12)) +
  geom_abline(data =  temp_qreq,
              aes(intercept = int,
                  slope = slope,
                  color = quantile)) +
  scale_color_manual(values = c("red","black","green")) +
  xlim(c(1,3.5)) +
  # ylim(c(-6,7)) +
  xlab("Inflation long-term expectations") +
  ylab("Inflation one year ahead") +
  ggtitle("Realized inflation one year ahead")


```


## The Inflation at Risk (IaR) Approach

\vspace{1em}

* IaR is a linear model of density forecasts
  + Based on quantile regressions
  + Parsimonious
  + Easy to interpret

\vspace{1em}

* Based on Banerjee et al. (2020)

\vspace{1em}

* Similar to the Growth at Risk approach (Adrian et al 2019,
Gurkov and Zohar 2021)



## Literature Review

\begin{itemize}
  \setlength\itemsep{1em}
  \item
  Banerjee et al. (2020) - Quantile regression on a panel of advanced and emerging
  markets sample.
  \item
  Lopez-Salido and Loria (2019) - United States (and Euro area) predictive inflation
  distribution using quantile regression.  Conditional mean of inflation does not convey
  an adequate representation of the overall pattern of inflation dynamics.
  \item
  Busetti et al (2015) - Euro area inflation using Philips curve and quantile regression.
\end{itemize}



## Main Results

\begin{itemize}
\setlength\itemsep{1.5em}
\item
In-sample properties of the distribution of expected inflation:
  \begin{enumerate}
  \setlength\itemsep{2em}
	\item
	Relatively balanced risks and stable uncertainty before 2014, decrease in uncertainty
	and (relative) increase in downside risks after 2014.
	\item
	Realized inflation and long-term expectations are the predominant factors explaining
	the changes in the features of the forecast distribution.	
	\item
	Oil prices contribute to
	the	evolution of forecast uncertainty, declining inflation environment explains
	variation	in skewness.
  \end{enumerate}


\end{itemize}






# Methodology and Estimation Results
## Methodology

\label{methodology}

\textbf{Quantile regressions --} estimate an equation for each quantile
$\tau$	and horizon 12 months ahead. The sample period is 2004-2019 at monthly frequency.

$Q^{\tau}_{t + 12}=\beta^{\tau}X_t+\epsilon^{\tau}_{t}$

$X_t=[1, \pi_{t},\pi^{e}_{t}, \hat{y}_{t}, oil_{t}, s_{t}]$

\footnotesize

where:

\begin{itemize}
  \item
  $\pi_{t}$ YoY CPI inflation excluding fruits, vegetables, and housing
  \item
  $\pi^{e}_{t}$ - five-year five-year forward breakeven inflation rates.
  \item
  $\hat{y}_{t}$ the output gap (HP filtered State-of-the Economy Index).
  \item
  $oil_{t}$ - the change in Brent Crude oil prices (USD).
  \item
  $s_{t}$ - the change in the NIS-USD exchange rate.
\end{itemize}

\begin{flushright}
	\hyperlink{QuantileReg}{\beamerbutton{quantile reg}}
\end{flushright}


## Positive Inflation and Oil Price Coefficients, Negative Output Gap

\label{coef_results}


```{r plot_coeffs,fig.width=13, fig.height=8}

coeff_df = iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  filter(horizon == 12) %>% 
  select(-horizon) %>% 
  mutate(partition = factor(partition,
    levels = c("cpi_yoy","beir5y5y" ,
               "meshulav_gap","brent_usd_percent_change",
               "nis_usd_percent_change"),
    labels = c("Inflation","Expectations","Output Gap",
               "Oil prices","Exchange Rate")
  ))


ggplot() +
  geom_col(data = coeff_df, aes(x = quantile, y = coeff,
                                fill = significant),
           width = 0.3) +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_wrap(~partition, scales = "free") +
  geom_hline(data = ols_coeffs,
             aes(yintercept = estimate,linetype = "OLS"),
             color = "blue") +
  scale_linetype_manual(values = "dashed") + 
  geom_hline(yintercept = 0, color = "black") + 
  xlab("Quantile") + ylab(NULL) +
  labs(
    caption = paste0(
      "Notes: Each column shows the estimated coefficients ",
      "from the quantile regression. ",
      "\n  Blue bars mark coefficients that are significant at 10%",
      "(see Koenker, 1994)"
    )
  ) +
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),
        strip.text = element_text(size = 12))

```

\hyperlink{OutACf}{\beamerbutton{Output gap ACF}}




# In-sample Features of the Forecast Distribution
## Downside Risks Increase After 2014

```{r plot_dist_timeseries}

iar_analysis$fitted_df %>%
  filter(horizon == 12) %>% 
  group_by(date = as.yearqtr(date), quantile) %>%
  summarise(avg_values = mean(fitted_values),
            .groups = "drop") %>%
  pivot_wider(names_from = "quantile",
              names_prefix = "q_",
              values_from = "avg_values") %>% 
  ggplot(aes(x = date)) +
  geom_ribbon(aes(ymin = q_0.25, ymax = q_0.75,
                  fill = "50% of the distribution"),
              alpha = 0.5) +
  geom_line(aes(y = q_0.5, color = "Median")) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1,
                                                     scale = 1)) +
  scale_fill_manual(values = c("50% of the distribution" = "grey")) + 
  scale_color_manual(values = c("Median" = "black")) + 
  guides(color = guide_legend(order = 1),
         fill = guide_legend(order = 2)) + 
  ylab(NULL) + xlab(NULL)  +
  ggtitle(paste0("Predicted annual inflation one year",
                 " ahead (quarterly averages)"))

```


## Lower Dispersion and Higher Downside Risks after 2014

```{r plot_skewness_1_quarter, fig.height=6}

n = nrow(df)

skew_se=sqrt( 6*n*(n-1) / ((n-2)*(n+1)*(n+3)) )

skew_df = iqr_df %>%
  filter(horizon == 12) %>% 
  select(-horizon) %>%
  pivot_longer(-date) %>%
  # group_by(date = as.yearqtr(date), name) %>%
  # summarise(value = mean(value), .groups = "drop") %>%
  mutate(name = factor(name, levels = c("iqr","skew"),
                       labels = c("Dispersion","Skewness")))

hline_df = skew_df %>%
  group_by(name) %>%
  summarise(val = mean(value)) %>% 
  mutate(color = "blue") %>% 
  mutate(linetype = "solid") %>% 
  bind_rows(tibble(name = rep("Skewness",2),
                   val = c(2 * skew_se, -2 * skew_se),
                   color = "black",
                   linetype = "dashed")) %>% 
  bind_rows(tibble(name = "Skewness",
                   val = 0,
                   color = "black",
                   linetype = "solid"))

skew_df%>%
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  facet_wrap(~name, scales = "free") +
  geom_hline(aes(yintercept = val, color = color, linetype = linetype),
             data = hline_df, show.legend = FALSE) + 
  scale_color_manual(values = c("black" = "black","blue" = "blue")) + 
  scale_linetype_manual(values = c("solid" = "solid", 
                                   "dashed" = "dashed")) + 
  labs(x = "", y = "",
       caption = paste0("Note: the dashed lines represent",
                        " ± 2 standard error estimates")) +
  theme(plot.caption = element_text(hjust = 0.5))


 rm(skew_df, hline_df, skew_se, n)

```

$Dispersion_{t} \equiv Q^{75}_{t} - Q^{25}_{t} \quad Skeweness_{t} \equiv \frac{Q^{75}_{t} + Q^{25}_{t} -2Q^{50}_{t}}{Dispersion_{t}}$

## Inflation environment and oil prices are the dominant risk factors

\label{FactorPlot}


```{r plot_skew_contributions, fig.height=7.5}


factor_contributions = calculate_disp_and_skew_contributons(iar_analysis) %>%
    group_by(date = as.yearqtr(date), category, horizon) %>%
    summarise(across(everything(), mean, na.rm = TRUE),
              .groups = "drop")

plot_df = make_plot_df(factor_contributions,labels_df)


plot_df %>% 
  mutate(facet = factor(facet, levels = c("iqr", "skew"),
                        labels = c("Dispersion", "Skewness"))) %>% 
  ggplot() + 
  geom_col(aes(date, contribution_value, fill = category)) + 
  geom_line(aes(date, total_value), size = 1) + 
  # scale_fill_viridis_d() + 
  facet_wrap(~facet, scales = "free") + 
  xlab(NULL) + ylab(NULL)


rm(factor_contributions, plot_df)

```

\vspace{-2em}


\begin{flushright}
\hyperlink{OutGap}{\beamerbutton{Output gap}}
\end{flushright}


## Realized inflation increases upside risks and uncertainty one year ahead


```{r inflation_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, cpi_yoy)), by = "date") %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = cpi_yoy, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1,
                                                     accuracy = 1)) +
  xlab("Realized inflation") + ylab(NULL)

```


## Inflation expectations increase upside risks and lowers uncertainty one year ahead


```{r expectation_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, beir5y5y)), by = "date") %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = beir5y5y, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1,
                                                     accuracy = 0.1)) +
  xlab("Inflation expectations") + ylab(NULL) + 
  theme(axis.text.x = element_text(hjust = 0.25))

```


## Oil prices stimulate inflation and decreases uncertainty and skeweness one year ahead


```{r oil_gap_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, x = brent_nis))) %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = x, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  xlab("Oil price") + ylab(NULL)

```



# Effective Lower Bound
## Inflation environment is still the dominant risk factor

\label{FactorPlotELB}


```{r eval=FALSE}

factor_contributions_elb = calculate_disp_and_skew_contributons(iar_analysis_elb)

temp = factor_contributions_elb %>% 
  mutate(indicator = if_else(str_detect(category,"_elb$"), "base","elb")) %>% 
  pivot_longer(-c(date, horizon, category, indicator)) %>% 
  pivot_wider(names_from = indicator) %>% 
  filter(horizon == 12) %>% 
  filter(date == as.yearmon("Jan 2015"))
  


```



```{r plot_skew_contributions_elb, fig.height=7.5}


factor_contributions_elb = calculate_disp_and_skew_contributons(iar_analysis_elb)

plot_df_elb = make_plot_df(factor_contributions_elb,
                           labels_df %>% 
                             bind_rows(labels_df %>% 
                                         mutate(across(everything(), ~paste0(.,"_elb"))) %>% 
                                         mutate(level = recode(level, intercept_elb = "elb"))))


plot_df_elb %>% 
  mutate(facet = factor(facet, levels = c("iqr", "skew"),
                        labels = c("Dispersion", "Skewness"))) %>% 
  ggplot() + 
  geom_col(aes(date, contribution_value, fill = category)) + 
  geom_line(aes(date, total_value), size = 1) + 
  # scale_fill_viridis_d() + 
  facet_wrap(~facet, scales = "free") + 
  xlab(NULL) + ylab(NULL)


rm(factor_contributions, plot_df, labels_df)

```

\vspace{-2em}


\begin{flushright}
\hyperlink{OutGap}{\beamerbutton{Output gap}}
\end{flushright}



# Out-of-Sample Forecast Performance
## Out-of-Sample Forecast

```{r out_of_sample_forecast_plot}

ggplot() +
  geom_ribbon(
    data = iar_forecast %>%
      filter(horizon == 12) %>%
      filter(quantile %in% c("0.1", "0.9")) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.1,
      ymax = q_0.9,
      fill = "80% of Distribution"
    ),
    alpha = 0.5) +
    geom_ribbon(
    data = iar_forecast %>%
      filter(quantile %in% c(0.25, 0.75)) %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.25,
      ymax = q_0.75,
      fill = "50% of Distribution"
    ),
    alpha = 0.8) +
    geom_line(
    data = iar_forecast %>%
      filter(quantile == "0.5") %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12),
    aes(x = date, y = forecast_values,
        color = "Forecasted Median 12 Month Earlier")
  ) +
  geom_line(
    data = df %>%
      filter(
        date >= iar_forecast %>%
          filter(horizon == 12) %>%
          pull(date) %>% min() + 1
      ),
    aes(x = date, y = cpi_yoy, color = "Realized Inflation")
  ) + 
  ylab("Percent") + xlab(NULL) +
  ggtitle("Quantiles of inflation") + 
  scale_fill_manual(values = c("grey","lightblue")) + 
  scale_color_manual(values = c("black","red")) + 
  theme(legend.text = element_text(size = 12))



```


## Out-of-Sample Forecast Performance

\vspace{2em}

\begin{itemize}
\setlength\itemsep{2em}
	\item
	IaR model compared to two alternatives:
	\begin{enumerate}
		\item
		Intercept only -- partial IaR model without explanatory variables
		\item
		Intercept and realized inflation -- partial IaR model
	\end{enumerate}
	\item
	The models are evaluated out of sample (expanding window starts at
	85 observations and adds one observation in each step)
\end{itemize}

## Probability Integral Transform (PIT)

\label{PIT}


For each quantile $\tau$ we compute  the percentage of observations that fall below the forecast quantile $\hat{Q}^{\tau}_{t}$:
	$$
	\varphi_{\tau} \equiv \frac{1}{T} \sum_{t=1}^{T} \mathbb{I}_{ \left\{ y_{t} <  \hat{Q}^{\tau}_{t} \right\} }.
	$$
\begin{itemize}
\setlength\itemsep{1em}
	\item
	A model is better fitted the closer $\varphi_{\tau}$ is to
	45-degree line.
	\item
	If the model perfectly fits the empirical  distribution, then
	the fraction of observations falling below quantile $\tau$
	should be exactly $\tau$, namely, $\varphi_{\tau}=\tau$.
\end{itemize}


\hyperlink{PITscore}{\beamergotobutton{PITscore}}

## Goodness of fit -- PIT score \newline (the closer to the black line the better)

\label{PITscore}

```{r pit_score}

# Confidence bands (Rossi et al 2019)

# size of OS sample for tests
OS_size=iar_forecast %>% 
  filter(horizon == 12) %>% 
  inner_join(select(df, date, cpi_yoy), by = c("forecast_target_date" = "date")) %>% 
  filter(!is.na(cpi_yoy)) %>%
  count(quantile) %>% 
  pull(n) %>% 
  unique() 

kappa_alpha= 1.34  #( p=0.01, kappa=1.61; p=0.05, kappa=1.34; p=0.10, kappa=1.21)


iar_pit = quantile_pit_score(
  forecast_df = iar_forecast %>%
    filter(horizon == 12),
  actual_df = select(df, actual_values = cpi_yoy, date)) %>%
  rename(iar = pit)

intercept_pit = quantile_pit_score(
  forecast_df = intercept_forecast  %>%
    filter(horizon == 12),
  actual_df = select(df, actual_values = cpi_yoy, date)) %>%
  rename(intercept = pit)

inflation_pit = quantile_pit_score(
  forecast_df = inflation_forecast %>%
    filter(horizon == 12),
  actual_df = select(df, actual_values = cpi_yoy, date)) %>%
  rename(realized_inflation = pit)

list(iar_pit, intercept_pit, inflation_pit) %>%
  reduce(inner_join, by = c("quantile", "horizon")) %>%
  pivot_longer(-c("quantile", "horizon")) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  mutate(name = factor(name,
                       levels = c("realized_inflation","iar",
                                  "intercept"),
                       labels = c("CPI only",
                                  "Inflation at risk",
                                  "Intercept"))) %>%
  ggplot(aes(x = quantile,y = value,color = name,group = name)) +
  geom_line(size = 0.75) +
  geom_abline(
    slope = 1,
    intercept = 0,
    color = "black",
    linetype = "solid"
  ) +
  geom_abline(
    slope = 1,
    intercept = c(kappa_alpha / OS_size ^ 0.5,-1 * (kappa_alpha / OS_size ^ 0.5)),
    color = "black",
    linetype = "dashed"
  ) +
  xlim(0,1) + ylim(0,1) +
  xlab("Quantile") + ylab(NULL) + 
  labs(caption = "Dashed lines are confidence bands (Rossi et al 2019) at p = 0.1 ")



```


\hyperlink{PIT}{\beamergotobutton{PIT}}

# Summary

\begin{itemize}
\setlength\itemsep{3em}
  \item
  The decline in inflation since 2014 was associated with a decline in uncertainty
  and a relative rise in downside risks to inflation.
  \item
  The decline in long-term expectations and oil prices played a prominent role
  in these developments.
  \item
  The model can also be used to assess inflation risks regularly. 
  
\end{itemize}

# Appendix {.unlisted .unnumbered}
## Output gap depresses inflation while increasing upside risks one year ahead


```{r output_gap_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, x = meshulav_gap)), by = "date") %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = x, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  xlab("Output gap") + ylab(NULL)

```


## Exchange rate increases downside risks and lowers uncertainty one year ahead


```{r fx_rate_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, x = nis_usd))) %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = x, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1,accuracy = 1)) +
  xlab("Exchange rate") + ylab(NULL) + 
  theme(axis.text.x = element_text(hjust = 0.25))
```




## Quantile Regression

\label{QuantileReg}

Model: for quantile $\tau$ and horizon $h$,
$$
Q^{\tau}_{t,h}=\beta^{\tau}_hX_t+\epsilon^{\tau}_{h,t}
$$

$\beta^{\tau}$ is  estimated by solving the minimization problem

$$
\min_{\beta^{\tau}}
\sum_{t=1}^T
\max \bigg\{
\tau \big( y_{t+h}- \beta^{\tau}X_t \big)
\, ,\,
(\tau-1) \big( y_{t+h}- \beta^{\tau}X_t \big)
\bigg\}
$$

Note: "Quantile crossing" handled using the method of Chernozhukov et al. (2010).

\begin{flushleft}
\hyperlink{methodology}{\beamergotobutton{Methodology}}
\end{flushleft}




## Autoregression in Output Gap

\label{OutACf}

```{r output_gap_ar}


out_gap_ar = df %>%
  pull(meshulav_gap) %>%
  acf(plot = FALSE)

tibble(acf = out_gap_ar$acf[,,1], lag = out_gap_ar$lag[,,1]) %>%
  ggplot(aes(x = lag, y = acf, fill = (lag == 12))) +
  geom_col(width = 0.5) +
  geom_hline(yintercept = c(-0.5,0.5), linetype = "dashed") +
  scale_fill_manual(values = c("grey","lightblue")) +
  theme(legend.position = "none") +
  xlab("Lag") + ylab(NULL) + ggtitle("Autocorrelation function of Output Gap")

```


\hyperlink{coef_results}{\beamerbutton{coeffs}}


## Positive (short term) Output Gap

```{r plot_gap_coeffs,fig.width=13, fig.height=8}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition == "meshulav_gap") %>%
  filter(horizon == 1) %>% 
  select(-horizon) %>% 
  mutate(partition = recode(partition, "meshulav_gap" = "Output Gap")) %>% 
  ggplot() +
  geom_col(aes(x = quantile, y = coeff, fill = significant),
           width = 0.3) +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  geom_hline(yintercept = 0, color = "black") + 
  xlab("Quantile") + ylab(NULL) + ggtitle("Output Gap coefficients at 1 quarter ahead") +
  labs(
    caption = paste0(
      "Notes: Each column shows the estimated coefficients ",
      "from the quantile regression. ",
      "\n  Blue bars mark coefficients that are significant at 10%",
      "(see Koenker, 1994)"
    )
  ) +
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),
        strip.text = element_text(size = 12))

```

\hyperlink{coef_results}{\beamerbutton{coeffs}}

## Output Gap

\label{OutGap}

```{r output_gap}

df %>% 
  ggplot(aes(x = date, y = meshulav_gap)) + 
  geom_line() + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  xlab(NULL) + ylab(NULL) + ggtitle("Output gap")

```

\hyperlink{FactorPlot}{\beamerbutton{Factor decomposition}}

## Goodness of fit --Quantile R-Squared \newline (the higher the better, negative means worse than intercept only)

```{r plot_r2_score}

iar_r2 = quantile_r2_score(
  forecast_df = iar_forecast,
  actual_df = select(df, actual_values = cpi_yoy, date),
  benchmark_df = intercept_forecast) %>%
  rename(iar = quantile_r2)

inflation_r2 = quantile_r2_score(
  forecast_df = inflation_forecast,
  actual_df = select(df, actual_values = cpi_yoy, date),
  benchmark_df = intercept_forecast) %>%
  rename(inflation_only = quantile_r2)

iar_r2 %>%
  inner_join(inflation_r2,by = c("horizon", "quantile")) %>%
  pivot_longer(-c(horizon, quantile)) %>%
  filter(horizon == 12) %>% 
  mutate(quantile = factor(quantile, levels = quantile_vec)) %>%
  mutate(name = factor(name,
                       labels = c("Inflation at Risk",
                                  "CPI only"))) %>% 
  mutate(name = fct_relevel(name, "CPI only")) %>% 
  ggplot(aes(x = quantile, y = value, fill = name)) +
  geom_col(position = "dodge") +
  # scale_fill_discrete(labels = c("IaR","Inflation only")) +
  xlab("Quantile") + ylab(NULL) + 
  facet_wrap(~horizon, scales = "free")

```


## Out of sample inflation only


```{r out_of_sample_inflation_only_forecast_plot}

ggplot() +
  geom_ribbon(
    data = inflation_forecast %>%
      filter(horizon == 12) %>%
      filter(quantile %in% c("0.1", "0.9")) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.1,
      ymax = q_0.9,
      fill = "80% of Distribution"
    ),
    alpha = 0.5) +
    geom_ribbon(
    data = inflation_forecast %>%
      filter(quantile %in% c(0.25, 0.75)) %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.25,
      ymax = q_0.75,
      fill = "50% of Distribution"
    ),
    alpha = 0.8) +
    geom_line(
    data = inflation_forecast %>%
      filter(quantile == "0.5") %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12),
    aes(x = date, y = forecast_values,
        color = "Forecasted Median 12 Month Earlier")
  ) +
  geom_line(
    data = df %>%
      filter(
        date >= inflation_forecast %>%
          filter(horizon == 12) %>%
          pull(date) %>% min() + 1
      ),
    aes(x = date, y = cpi_yoy, color = "Realized Inflation")
  ) + 
  ylab("Percent") + xlab(NULL) +
  ggtitle("Quantiles of inflation") + 
  scale_fill_manual(values = c("grey","lightblue")) + 
  scale_color_manual(values = c("black","red")) + 
  theme(legend.text = element_text(size = 12))



```


## Out of sample intercept only


```{r out_of_sample_intercept_only_forecast_plot}

ggplot() +
  geom_ribbon(
    data = intercept_forecast %>%
      filter(horizon == 12) %>%
      filter(quantile %in% c("0.1", "0.9")) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.1,
      ymax = q_0.9,
      fill = "80% of Distribution"
    ),
    alpha = 0.5) +
    geom_ribbon(
    data = intercept_forecast %>%
      filter(quantile %in% c(0.25, 0.75)) %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.25,
      ymax = q_0.75,
      fill = "50% of Distribution"
    ),
    alpha = 0.8) +
    geom_line(
    data = intercept_forecast %>%
      filter(quantile == "0.5") %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12),
    aes(x = date, y = forecast_values,
        color = "Forecasted Median 12 Month Earlier")
  ) +
  geom_line(
    data = df %>%
      filter(
        date >= intercept_forecast %>%
          filter(horizon == 12) %>%
          pull(date) %>% min() + 1
      ),
    aes(x = date, y = cpi_yoy, color = "Realized Inflation")
  ) + 
  ylab("Percent") + xlab(NULL) +
  ggtitle("Quantiles of inflation") + 
  scale_fill_manual(values = c("grey","lightblue")) + 
  scale_color_manual(values = c("black","red")) + 
  theme(legend.text = element_text(size = 12))



```


## Factor decomposition

```{r eval=FALSE}

factor_contributions = map_dfr(list("0.25" = 0.25,
                                    "0.5" = 0.5,
                                    "0.75" = 0.75),                              extract_factor_contribution_from_gar_model,
                               gar_model = iar_analysis,
                               .id = "quantile") %>% 
  pivot_longer(-c("date","horizon", "quantile"),names_to = "factor",
               values_to = "factor_contribution") %>% 
  pivot_wider(id_cols = c("date","horizon","factor"),names_from = "quantile",
              values_from = "factor_contribution",names_prefix = "q_")

factor_contributions = factor_contributions %>% 
  inner_join(calculate_skew_and_iqr(iar_analysis), by=c("date", "horizon")) %>% 
  filter(horizon == 12) %>% 
  mutate(contribution_U = q_0.75 - q_0.5,
         contribution_D = q_0.5 - q_0.25,
         contribution_iqr = q_0.75 - q_0.25,
         contribution_skewness=(contribution_U - contribution_D) / iqr) %>%
  group_by(quarter = as.yearqtr(date),factor, horizon) %>%
  summarise(across(everything(), mean, na.rm = TRUE), .groups = "drop")

```

```{r eval=FALSE}

data_iqr = factor_contributions %>% 
  select(factor, quarter, date, iqr, contribution_iqr) %>% 
  group_by(factor) %>% 
  mutate(contribution_iqr = scale(contribution_iqr,scale = FALSE)[,1]) %>% 
  ungroup() %>% 
  mutate(iqr = scale(iqr, scale = FALSE)[,1]) %>% 
  mutate(factor = factor(factor, labels = c()))

ggplot() + 
  geom_col(data = data_iqr,
           aes(x = date, y = contribution_iqr, fill = factor)) + 
  geom_line(data = data_iqr,
            aes(x = date, y = iqr)) + 
  xlab(NULL) + ylab(NULL)


rm(data_iqr)

```

