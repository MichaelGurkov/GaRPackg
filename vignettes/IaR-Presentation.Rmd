---
title: "Inflation Risks in Israel"
author: "Michael Gurkov and Osnat Zohar"
institute: "Bank of Israel \\newline Research Department \\newline \\newline Any views expressed in the Discussion Paper are those of the authors and do not necessarily reflect those of the Bank of Israel"
date: "25 July, 2021"
classoption: t
output:
  beamer_presentation:
    includes:
      in_header: !expr here::here('vignettes/GaR-PresentationPreamble.tex')
    latex_engine: xelatex
    slide_level: 2
# bibliography: "GaR.bib"
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,
  warning = FALSE, comment = "#>"

)
```


```{r init_setup}

devtools::load_all()

library(ggcorrplot)

library(mFilter)

library(tidyverse)

library(lubridate)

library(slider)

library(cowplot)

library(broom)

library(gghighlight)

setwd(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
  "\\Documents\\GaRPackg\\vignettes"))


```



```{r set_params}

partitions_list = list(
  inflation = c("cpi"),
  exchange_rate = c("nis_usd"),
  oil_p = c("brent_usd"),
  output_gap = c("meshulav_gap"),
  expectation = c("beir5y5y")
)



horizon_list=c(1,12)

quantile_vec=c(0.10,0.25,0.5,0.75,0.90)



theme_set(theme_bw() + 
            theme(title = element_text(size = 20),
                axis.text = element_text(size = 15),
                axis.title = element_text(size = 15),
                strip.text = element_text(size = 15),
                legend.position = "bottom",
                legend.title = element_blank(),
                legend.text = element_text(size = 15)))

# plot_names = tribble(
#   ~var_name, ~plot_name,
#   "Intercept", "Intercept",
#   "cpi", "Inflation",
#   "cpi_lag", "Inflation",
#   "spf1y","Expectations",
#   "beir5y5y","LT Expect.",
#   "nis_usd", "Exchange Rate",
#   "rel_tradables", "Tradables",
#   "brent_usd", "Oil Prices",
#   "meshulav_gap","Output Gap"
# )



```

```{r load_data}

raw_df = import_from_fame_template(
  paste0(
    file.path(Sys.getenv("USERPROFILE")),
    "\\OneDrive - Bank Of Israel\\Data\\BoI\\IaR_data\\data_Inflation_at_Risk_monthly.csv"
  ),data_frequency = "monthly"
)

df = raw_df %>% 
  mutate(rel_tradables = cpi_tradables / cpi_nontradables_excl_fv_hous) %>%
  preprocess_df(
    vars_to_yoy = c(
      "cpi",
      "cpi_excl_fv",
      "cpi_excl_fv_hous",
      "cpi_excl_hous",
      "rel_tradables",
      "cpi_oecd",
      "cpi_us",
      "cpi_euro",
      "debt_business",
      "debt_households",
      "house_price",
      "ta125"
    ),
    vars_to_percent_changes = c("nis_usd",
                                "neer",
                                "brent_usd",
                                "brent_nis",
                                "non_energy_p"),
    convert_to_percent_units = TRUE
  ) %>%
  mutate(target = target * 100) %>% 
  mutate(cpi_orig = cpi) %>% 
  mutate(cpi = cpi_excl_fv_hous) %>% 
  mutate(cpi_lag = lag(cpi)) %>% 
  filter(year(date) >= 2004 & year(date) <= 2019)

filter_obj =  hpfilter(df$madad_meshulav,freq = 1600)

df = df %>% 
  mutate(meshulav_gap = filter_obj$cycle / filter_obj$trend[,1] * 100)


```

```{r run_analysis}

iar_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df,
  target_var_name = "cpi",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(
    output_gap = list("output_gap", TRUE),
    expectation = list("beir5y5y", TRUE)
  )
)

ols_coeffs = iar_analysis$reg_df %>%
  select(cpi_12, ends_with("xreg")) %>%
  lm(paste("cpi_12 ~ ."), .) %>%
  tidy() %>%
  filter(!term == "(Intercept)") %>%
  mutate(term = str_remove_all(term, "_xreg")) %>%
  mutate(partition = factor(
    term,
    levels = c("cpi", "beir5y5y" , "meshulav_gap", "brent_usd", "nis_usd"),
    labels = c(
      "Inflation",
      "Expectations",
      "Output Gap",
      "Oil prices",
      "Exchange Rate"
    )
  )) %>%
  select(partition, estimate)


```

```{r iqr_df}

iqr_df = iar_analysis %>% 
  calculate_skew_and_iqr()

```


```{r out_of_sample_forecast}

win_len = 109

iar_forecast = get_gar_forecast(partitions_list = partitions_list,
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

intercept_forecast = get_gar_forecast(partitions_list = NULL,
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

inflation_forecast = get_gar_forecast(partitions_list = list(inflation = "cpi"),
                                vars_df = df,
                                target_var_name = "cpi",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = win_len,
                                win_type_expanding = TRUE)

rm(win_len)


```


## Motivation



\begin{quote}

\small

"Monetary policy responded first in the summer of 2012 by acting to defuse the sovereign debt crisis, which had evolved from a \textbf{tail risk for inflation} into a material threat to price stability."

\vspace{1em}

Mario Draghi, ECB President, Sintra, June 2019

\end{quote}

\vspace{2em}

\begin {itemize}
\setlength\itemsep{1em}
	\item
	We analyze the distribution of future inflation since the current inflation target
	range was set.
	\item
	We provide a methodological tool for assessing risks to inflation in Israel
	using Philips curve specification:


\begin{center}
\begin{block}{}

	Given current real and nominal conditions, what is the distribution of
	expected inflation?

\end{block}
\end{center}

\end{itemize}


## Motivation

```{r plot_inf_rates}

df %>%
  select(date, cpi) %>%
  mutate(cpi_ma = slide_dbl(cpi,mean,.before = 48,.complete = TRUE)) %>%
  mutate(cpi_var = slide_dbl(cpi,var,.before = 48,.complete = TRUE)) %>%
  pivot_longer(-date) %>%
  ggplot(aes(x = date, y = value, color = name)) +
  geom_line() +
  scale_color_discrete(labels = c("CPI Inflation","CPI Moving Average (48 periods)",
                                "CPI Variance (48 periods)")) +
  xlab(NULL) + ylab(NULL) +
  ggtitle(paste0("Year-on-Year CPI Inflation Excluding Fruits,",
                 " Vegetables, and Housing \n (Monthly,2004-2019)")) + 
  theme(plot.title = element_text(size = 17))


```

## Outline

\tableofcontents[sectionstyle=show/show,subsectionstyle=hide/hide]

<!-- ## Quantile regression -->

<!-- ```{r} -->
<!-- temp_df = df %>% -->
<!--   select("cpi") %>% -->
<!--   add_leads_to_target_var(target_var_name = "cpi", -->
<!--                           leads_vector = 12) %>% -->
<!--   filter(complete.cases(.)) -->

<!-- temp_qreq = rq("cpi_12 ~ cpi", -->
<!--                tau = c(0.05,0.5,0.95), -->
<!--                data = temp_df) %>% -->
<!--   coefficients() %>% -->
<!--   t() %>% -->
<!--   as.data.frame() %>% -->
<!--   rownames_to_column() %>% -->
<!--   mutate(rowname = str_remove_all(rowname, "tau= ")) %>% -->
<!--   rename(quantile = rowname, -->
<!--          my_int = `(Intercept)`, -->
<!--          my_slope = cpi_12) -->

<!-- temp_df %>% -->
<!--   ggplot(aes(x = cpi, -->
<!--              y = cpi_12)) + -->
<!--   geom_point() + -->
<!--   geom_abline(data = temp_qreq, -->
<!--               aes(intercept = my_int, -->
<!--                   slope = my_slope, -->
<!--                   color = quantile)) + -->
<!--   scale_x_continuous( -->
<!--     labels = scales::percent_format(accuracy = 1)) + -->
<!--   scale_y_continuous( -->
<!--     labels = scales::percent_format(accuracy = 1)) + -->
<!--   scale_color_manual(values = c("red","black","green")) + -->
<!--   xlab("Lagged inflation") + -->
<!--   ylab("Inflation") + -->
<!--   theme(legend.position = "none") -->


<!-- ``` -->


## The Inflation at Risk (IaR) Approach

\vspace{1em}

* IaR is a linear model of density forecasts
  + Based on quantile regression
  + Parsimonious
  + Easy to interpret

\vspace{1em}

* Based on Banerjee et al. (2020)

\vspace{1em}

* Similar to the Growth at Risk approach (Adrian et al 2019,
Gurkov and Zohar 2021)



## Literature Review

\begin{itemize}
  \setlength\itemsep{1em}
  \item
  Banerjee et al. (2020) - Panel quantile regression on advanved and emerging
  markets sample.
  \item
  Lopez-Salido and Loria (2019) - United States (and Euro area) predictive inflation
  distribution using quantile regression.  Conditional mean of inflation does not convey
  an adequate representation of the overall pattern of inflation dynamics.
  \item
  Busetti et al (2015) - Euro area inflation using Philips curve and quantile regression.
\end{itemize}



## Main Results

\begin{itemize}
\setlength\itemsep{1.5em}
\item
In-sample properties of the distribution of expected inflation:
  \begin{enumerate}
  \setlength\itemsep{2em}
	\item
	Relatively balanced risk and stable uncertainty before 2014, decrease in uncertainty
	and (relative) increase in downside risks after
	\item
	Realized inflation and long term expectations are the predominant factor explaining
	the changes in the features of the forecast distribution.	
	\item
	Oil prices contribute to
	the	evolution of forecast uncertainty, declining inflation environment explains
	variation	in skewness.
  \end{enumerate}


\end{itemize}






# Methodology and Estimation Results
## Methodology

\label{methodology}

\textbf{Quantile regressions --} estimate an equation for each quantile
$\tau$	and horizon 12 months ahead. The sample period is 2004-2019 at monthly frequency.

$Q^{\tau}_{t + 12}=\beta^{\tau}X_t+\epsilon^{\tau}_{t}$

$X_t=[1, \pi_{t},\pi^{e}_{t}, \hat{y}_{t}, oil_{t}, s_{t}]$

\footnotesize

where:

\begin{itemize}
  \item
  $\pi_{t}$ YoY CPI inflation excluding fruits, vegetables, and housing
  \item
  $\pi^{e}_{t}$ - five-year five-year forward breakeven inflation rates.
  \item
  $\hat{y}_{t}$ the output gap (HP filtered State-of-the Economy Index).
  \item
  $oil_{t}$ - the change in Brent Crude oil prices (USD).
  \item
  $s_{t}$ - the change in the NIS-USD exchange rate.
\end{itemize}

\begin{flushright}
	\hyperlink{QuantileReg}{\beamerbutton{quantile reg}}
\end{flushright}


## Positive Inflation and Oil Price Coefficients, Negative Output Gap


```{r plot_coeffs_draft, fig.height=7.5,eval=FALSE}

coeff_df = iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  filter(horizon == 12) %>% 
  select(-horizon) %>% 
  mutate(partition = factor(
    partition,
    levels = c("cpi","beir5y5y" ,"meshulav_gap","brent_usd","nis_usd"),
    labels = c("Inflation","Expectations","Output Gap", "Oil prices","Exchange Rate")
  ))


ggplot() +
  geom_col(data = coeff_df, aes(x = quantile, y = coeff, fill = significant),
           width = 0.3) +
  scale_fill_manual(values = c("significant" = "lightblue","non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_grid(rows = vars(partition), scales = "free") +
  geom_hline(data = ols_coeffs,aes(yintercept = estimate,linetype = "OLS"),
             color = "blue") +
  scale_linetype_manual(values = "dashed") + 
  xlab("Quantile") + ylab(NULL) +
  labs(
    caption = paste0(
      "Notes: Each column shows the estimated coefficients ",
      "from the quantile regression at a specific forecast horizon. ",
      "\n  Blue bars mark coefficients that are significant at 10%",
      "(see Koenker, 1994)"
    )
  ) +
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),
        strip.text = element_text(size = 12))

```


```{r plot_coeffs,fig.width=13, fig.height=8}

coeff_df = iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  filter(horizon == 12) %>% 
  select(-horizon) %>% 
  mutate(partition = factor(
    partition,
    levels = c("cpi","beir5y5y" ,"meshulav_gap","brent_usd","nis_usd"),
    labels = c("Inflation","Expectations","Output Gap", "Oil prices","Exchange Rate")
  ))


ggplot() +
  geom_col(data = coeff_df, aes(x = quantile, y = coeff, fill = significant),
           width = 0.3) +
  scale_fill_manual(values = c("significant" = "lightblue","non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_wrap(~partition, scales = "free",nrow = 1) +
  geom_hline(data = ols_coeffs,aes(yintercept = estimate,linetype = "OLS"),
             color = "blue") +
  scale_linetype_manual(values = "dashed") + 
  geom_hline(yintercept = 0, color = "black") + 
  xlab("Quantile") + ylab(NULL) +
  labs(
    caption = paste0(
      "Notes: Each column shows the estimated coefficients ",
      "from the quantile regression at a specific forecast horizon. ",
      "\n  Blue bars mark coefficients that are significant at 10%",
      "(see Koenker, 1994)"
    )
  ) +
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),
        strip.text = element_text(size = 12))

```



```{r inflation, eval=FALSE}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition == "cpi") %>%
  filter(horizon == 12) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  ggplot() +
  geom_line(aes(x = quantile, y = coeff, color = horizon)) +
  # geom_errorbar(aes(x = quantile, ymax = high, ymin = low, color = horizon),
  #               width = 0.05) +
  geom_hline(
    aes(yintercept = estimate),
    data = ols_coeffs[ols_coeffs$partition == "Inflation",],
    color = "blue",
    linetype = "dashed"
  )

```


```{r fx_rate, eval=FALSE}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition == "nis_usd") %>%
  filter(horizon == 12) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  ggplot() +
  geom_line(aes(x = quantile, y = coeff, color = horizon)) +
  # geom_errorbar(aes(x = quantile, ymax = high, ymin = low, color = horizon),
  #               width = 0.05) +
  geom_hline(
    aes(yintercept = estimate),
    data = ols_coeffs[ols_coeffs$partition == "Exchange Rate",],
    color = "blue",
    linetype = "dashed"
  )

```


```{r oil_price, eval=FALSE}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition == "brent_usd") %>%
  filter(horizon == 12) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  ggplot() +
  geom_line(aes(x = quantile, y = coeff, color = horizon)) +
  # geom_errorbar(aes(x = quantile, ymax = high, ymin = low, color = horizon),
  #               width = 0.05) +
  geom_hline(
    aes(yintercept = estimate),
    data = ols_coeffs[ols_coeffs$partition == "Oil prices",],
    color = "blue",
    linetype = "dashed"
  )

```


```{r output, eval=FALSE}

iar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition == "meshulav_gap") %>%
  filter(horizon == 12) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  ggplot() +
  geom_line(aes(x = quantile, y = coeff, color = horizon)) +
  # geom_errorbar(aes(x = quantile, ymax = high, ymin = low, color = horizon),
  #               width = 0.05) +
  geom_hline(
    aes(yintercept = estimate),
    data = ols_coeffs[ols_coeffs$partition == "Output Gap",],
    color = "blue",
    linetype = "dashed"
  )

```




# In-sample Features of the Forecast Distribution
## Downside Risks Increase After 2014

```{r plot_dist_timeseries}

plot_df = iar_analysis$fitted_df %>%
  filter(quantile %in% c(0.25,0.5,0.75)) %>%
  filter(horizon == 12) %>%
  select(-horizon) %>%
  group_by(date = as.yearqtr(date), quantile) %>%
  summarise(avg_values = mean(fitted_values) * 4, .groups = "drop")

ggplot() +
  geom_line(data = plot_df %>%
              filter(quantile == "0.5"), aes(x = date, y = avg_values)) +
  geom_ribbon(data = plot_df %>%
                filter(quantile %in% c(0.25,0.75)) %>%
                pivot_wider(names_from = "quantile",
                            names_prefix = "q_",
                            values_from = "avg_values"),
              aes(x = date, ymin = q_0.25, ymax = q_0.75), alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1,scale = 1)) +
  ylab(NULL) + xlab(NULL)  +
  ggtitle("Predicted annual inflation one year ahead (quarterly averages)")


```


## Lower Dispersion and Higher Downside Risks after 2014

```{r plot_skewness_1_quarter, fig.height=6}

n = nrow(df)

skew_se=sqrt( 6*n*(n-1) / ((n-2)*(n+1)*(n+3)) )

skew_df = iqr_df %>%
  filter(horizon == 12) %>% 
  select(-horizon) %>%
  pivot_longer(-date) %>%
  # group_by(date = as.yearqtr(date), name) %>%
  # summarise(value = mean(value), .groups = "drop") %>%
  mutate(name = factor(name, levels = c("iqr","skew"),
                       labels = c("Dispersion","Skewness")))

hline_df = skew_df %>%
  group_by(name) %>%
  summarise(val = mean(value)) %>% 
  mutate(color = "blue") %>% 
  mutate(linetype = "solid") %>% 
  bind_rows(tibble(name = rep("Skewness",2),
                   val = c(2 * skew_se, -2 * skew_se),
                   color = "black",
                   linetype = "dashed")) %>% 
  bind_rows(tibble(name = "Skewness",
                   val = 0,
                   color = "black",
                   linetype = "solid"))

skew_df%>%
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  facet_wrap(~name, scales = "free") +
  geom_hline(aes(yintercept = val, color = color, linetype = linetype),
             data = hline_df, show.legend = FALSE) + 
  scale_color_manual(values = c("black" = "black","blue" = "blue")) + 
  scale_linetype_manual(values = c("solid" = "solid", "dashed" = "dashed")) + 
  labs(x = "", y = "",
       caption = "Note: the dashed lines represent Â± 2 standard error estimates") +
  theme(plot.caption = element_text(hjust = 0.5))


 rm(skew_df, hline_df, skew_se, n)

```

$Dispersion_{t} \equiv Q^{75}_{t} - Q^{25}_{t} \quad Skeweness_{t} \equiv \frac{Q^{75}_{t} + Q^{25}_{t} -2Q^{50}_{t}}{Dispersion_{t}}$

## Inflation environment and oil prices are the dominant risk factors


```{r}

means_vec = iqr_df %>% 
  filter(horizon == 12) %>% 
  select(skew,iqr) %>% 
  summarise(across(everything(), mean))


labels_df = tibble(level = c("cpi","nis_usd","brent_usd","meshulav_gap","exp_int"),
                   label = c("Inflation","Exchange Rate","Oil prices","Output Gap",
                             "Exp. and Intercept"))

factors_cont_df = iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.25") %>%
  mutate(quantile = 0.25) %>%
  bind_rows(iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.75") %>%
  mutate(quantile = 0.75)) %>%
  bind_rows(iar_analysis %>%
  extract_factor_contribution_from_gar_model(target_quantile = "0.5") %>%
  mutate(quantile = 0.5)) %>%
  filter(horizon == 12) %>% 
  filter(date >= as.yearmon("Jan 2007")) %>% 
  pivot_longer(-c(date, quantile, horizon))


skew_plot_df = factors_cont_df %>% 
  pivot_wider(id_cols = c(date,name, horizon), names_from = quantile,
              names_prefix = "q_") %>% 
  left_join(iqr_df, by = c("date", "horizon")) %>% 
  mutate(skew_cont = (q_0.75 + q_0.25 - 2 * q_0.5) / iqr) %>% 
  select(-starts_with("q_"),-horizon,-iqr) %>% 
  group_by(date = as.yearqtr(date), name) %>% 
  summarise(across(everything(),mean, na.rm = TRUE), .groups = "drop")  %>% 
  pivot_wider(names_from = name, values_from = skew_cont) %>% 
  mutate(exp_int = intercept + beir5y5y - means_vec$skew) %>% 
  mutate(skew = skew - means_vec$skew) %>%
  select(-c(intercept,beir5y5y)) %>% 
  pivot_longer(-c(date,skew)) %>% 
  mutate(name = factor(name,levels = labels_df$level, labels = labels_df$label))


disp_plot_df = factors_cont_df %>% 
  pivot_wider(id_cols = c(date,name, horizon), names_from = quantile,
              names_prefix = "q_") %>% 
  left_join(iqr_df, by = c("date", "horizon")) %>% 
  mutate(iqr_cont = q_0.75 - q_0.25) %>%
  select(-starts_with("q_"),-horizon,-skew) %>% 
  group_by(date = as.yearqtr(date), name) %>% 
  summarise(across(everything(),mean, na.rm = TRUE), .groups = "drop")  %>% 
  pivot_wider(names_from = name, values_from = iqr_cont) %>% 
  mutate(exp_int = intercept + beir5y5y - means_vec$iqr) %>% 
  mutate(iqr = iqr - means_vec$iqr) %>% 
  select(-c("intercept","beir5y5y")) %>% 
  pivot_longer(-c(date,iqr)) %>% 
  mutate(name = factor(name,levels = labels_df$level, labels = labels_df$label))



```


```{r plot_factor_decomposition, fig.height=6}

skew_plot = ggplot() + 
  geom_col(aes(x = date, y = value, fill = name), data = skew_plot_df) + 
  geom_line(aes(x = date, y = skew), data = skew_plot_df, size = 1) + 
  xlab(NULL) + ylab(NULL) + ggtitle("Skewness")


disp_plot =  ggplot() + 
  geom_col(aes(x = date, y = value, fill = name), data = disp_plot_df) + 
  geom_line(aes(x = date, y = iqr), data = disp_plot_df, size = 1) + 
  xlab(NULL) + ylab(NULL) + ggtitle("Dispersion")


plot_legend = get_legend(disp_plot)

plots_row = plot_grid(disp_plot +
            theme(legend.position = "none"),
          skew_plot +
            theme(legend.position = "none"))

plot_grid(plots_row, plot_legend,nrow = 2,rel_heights = c(4,1))

rm(disp_plot, skew_plot, plot_legend, plots_row)


```

\scriptsize

$E(Disp_{t + 12}|X_{t}) = (\beta^{75} - \beta^{25})X_{t} \quad E(Skew_{t + 12}|X_{t}) = \frac{(\beta^{75}_{t}+\beta^{25}_{t}-2\beta^{50}_{t})X_{t}}{Disp_{t+12}}$


## Realized inflation increases upside risks and uncertainty one year ahead


```{r inflation_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, cpi)), by = "date") %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = cpi, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1, accuracy = 1)) +
  xlab("Realized inflation") + ylab(NULL)

```


## Inflation expectation increases upside risks and lowers uncertainty one year ahead


```{r expectation_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, beir5y5y)), by = "date") %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = beir5y5y, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1, accuracy = 0.1)) +
  xlab("Inflation expectations") + ylab(NULL) + 
  theme(axis.text.x = element_text(hjust = 0.25))

```


## Oil price stimulate inflation and decreases uncertainty and skeweness one year ahead


```{r oil_gap_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, x = brent_nis))) %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = x, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  xlab("Oil price") + ylab(NULL)

```


# Out-of-Sample Forecast Performance
## Out-of-Sample Forecast Performance

\vspace{2em}

\begin{itemize}
\setlength\itemsep{2em}
	\item
	IaR model compared to two alternatives:
	\begin{enumerate}
		\item
		Intercept only -- partial IaR model without explanatory variables
		\item
		Intercept and realized inflation -- partial IaR model
	\end{enumerate}
	\item
	The models are evaluated out of sample (expanding window starts at
	85 observations and adds one observation in each step)
\end{itemize}

## Out-of-Sample Forecast

```{r out_of_sample_forecast_plot}

ggplot() +
  geom_ribbon(
    data = iar_forecast %>%
      filter(horizon == 12) %>%
      filter(quantile %in% c("0.10", "0.90")) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.10,
      ymax = q_0.90,
      fill = "80% of Distribution"
    ),
    alpha = 0.5) +
    geom_ribbon(
    data = iar_forecast %>%
      filter(quantile %in% c(0.25, 0.75)) %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12) %>%
      pivot_wider(
        names_from = "quantile",
        names_prefix = "q_",
        values_from = "forecast_values"
      ),
    aes(
      x = date,
      ymin = q_0.25,
      ymax = q_0.75,
      fill = "50% of Distribution"
    ),
    alpha = 0.8) +
    geom_line(
    data = iar_forecast %>%
      filter(quantile == "0.50") %>%
      filter(horizon == 12) %>%
      mutate(date = date + as.numeric(horizon)  / 12),
    aes(x = date, y = forecast_values, color = "Forecasted Median 12 Month Earlier")
  ) +
  geom_line(
    data = df %>%
      filter(
        date >= iar_forecast %>%
          filter(horizon == 12) %>%
          pull(date) %>% min() + 1
      ),
    aes(x = date, y = cpi, color = "Realized Inflation")
  ) + 
  ylab("Percent") + xlab(NULL) +
  ggtitle("Quantiles of inflation") + 
  scale_fill_manual(values = c("grey","lightblue")) + 
  scale_color_manual(values = c("black","red")) + 
  theme(legend.text = element_text(size = 12))



```


## Goodness of fit -- PIT score \newline (the closer to the black line the better)

\label{PITscore}

```{r pit_score}

iar_pit = quantile_pit_score(
  forecast_df = iar_forecast %>%
    filter(horizon == 12),
  actual_df = select(df, actual_values = cpi, date)) %>%
  rename(iar = pit)

intercept_pit = quantile_pit_score(
  forecast_df = intercept_forecast  %>%
    filter(horizon == 12),
  actual_df = select(df, actual_values = cpi, date)) %>%
  rename(intercept = pit)

inflation_pit = quantile_pit_score(
  forecast_df = inflation_forecast %>%
    filter(horizon == 12),
  actual_df = select(df, actual_values = cpi, date)) %>%
  rename(realized_inflation = pit)

list(iar_pit, intercept_pit, inflation_pit) %>%
  reduce(inner_join, by = c("quantile", "horizon")) %>%
  pivot_longer(-c("quantile", "horizon")) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  mutate(name = factor(name,
                       levels = c("realized_inflation","iar","intercept"),
                       labels = c("CPI only","Inflation at risk","Intercept"))) %>%
  ggplot(aes(x = quantile,y = value,color = name,group = name)) +
  geom_line() +
  geom_abline(
    slope = 1,
    intercept = 0,
    color = "black",
    linetype = "dashed"
  ) +
  xlim(0,1) + ylim(0,1) +
  xlab("Quantile") + ylab(NULL)



```


\hyperlink{PIT}{\beamergotobutton{PIT}}

# Summary

\begin{itemize}
\setlength\itemsep{3em}
  \item
  The decline in inflation since 2014 was associated with a decline in uncertainty
  and a relative rise in downside risks to inflation.
  \item
  The decline in long-term expectations and oil prices played a prominent role
  in these developments.
  \item
  The model can also be used to assess inflation risks regularly. 
  
\end{itemize}

# Appendix {.unlisted .unnumbered}
## Output gap depresses inflation while increasing upside risks one year ahead


```{r output_gap_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, x = meshulav_gap)), by = "date") %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = x, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  xlab("Output gap") + ylab(NULL)

```


## Exchange rate increases downside risks and lowers uncertainty one year ahead


```{r fx_rate_iqr}

iqr_df %>%
  filter(horizon == 12) %>%
  left_join(select(df, c(date, x = nis_usd))) %>%
  left_join(iar_analysis$fitted_df %>%
              filter(quantile == 0.5) %>%
              select(date, horizon, median = fitted_values)) %>%
  pivot_longer(cols = c(skew,iqr,median)) %>%
  mutate(name = factor(name, levels = c("median", "iqr","skew"),
                       labels = c("Median","Dispersion","Skewness"))) %>%
  ggplot(aes(x = x, y = value)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~name, scales = "free") +
  scale_x_continuous(labels = scales::percent_format(scale = 1,accuracy = 1)) +
  xlab("Exchange rate") + ylab(NULL) + 
  theme(axis.text.x = element_text(hjust = 0.25))
```



## Probability Integral Transform (PIT)

\label{PIT}


For each quantile $\tau$ and horizon $h$, we compute  the percentage of observations that fall below the forecast quantile $\hat{Q}^{\tau}_{t,h}$:
	$$
	\varphi_{\tau,h} \equiv \frac{1}{T-h} \sum_{t=1}^{T-h} \mathbb{I}_{ \left\{ y_{t+h} <  \hat{Q}^{\tau}_{t,h} \right\} }.
	$$
\begin{itemize}
\setlength\itemsep{1em}
	\item
	A model is better fitted the closer $\varphi_{\tau,h}$ is to
	45-degree line.
	\item
	If the model perfectly fits the empirical  distribution, then
	the fraction of observations falling below quantile $\tau$
	should be exactly $\tau$, namely, $\varphi_{\tau,h}=\tau$.
\end{itemize}


\hyperlink{PITscore}{\beamergotobutton{PITscore}}

## Quantile Regression

\label{QuantileReg}

Model: for quantile $\tau$ and horizon $h$,
$$
Q^{\tau}_{t,h}=\beta^{\tau}_hX_t+\epsilon^{\tau}_{h,t}
$$

$\beta^{\tau}$ is  estimated by solving the minimization problem

$$
\min_{\beta^{\tau}}
\sum_{t=1}^T
\max \bigg\{
\tau \big( y_{t+h}- \beta^{\tau}X_t \big)
\, ,\,
(\tau-1) \big( y_{t+h}- \beta^{\tau}X_t \big)
\bigg\}
$$

Note: "Quantile crossing" handled using the method of Chernozhukov et al. (2010).

\begin{flushleft}
\hyperlink{methodology}{\beamergotobutton{Methodology}}
\end{flushleft}




## Autoregression in Output Gap

```{r output_gap_ar}


out_gap_ar = df %>%
  pull(meshulav_gap) %>%
  acf(plot = FALSE)

tibble(acf = out_gap_ar$acf[,,1], lag = out_gap_ar$lag[,,1]) %>%
  ggplot(aes(x = lag, y = acf, fill = (lag == 12))) +
  geom_col(width = 0.5) +
  geom_hline(yintercept = c(-0.5,0.5), linetype = "dashed") +
  scale_fill_manual(values = c("grey","lightblue")) +
  theme(legend.position = "none") +
  xlab("Lag") + ylab(NULL) + ggtitle("Autocorrelation function of Output Gap")

```




## Goodness of fit --Quantile R-Squared \newline (the higher the better, negative means worse than intercept only)

```{r plot_r2_score}

iar_r2 = quantile_r2_score(
  forecast_df = iar_forecast,
  actual_df = select(df, actual_values = cpi, date),
  benchmark_df = intercept_forecast %>%
    rename(benchmark_values = forecast_values)) %>%
  rename(iar_r2 = quantile_r2)

inflation_r2 = quantile_r2_score(
  forecast_df = inflation_forecast,
  actual_df = select(df, actual_values = cpi, date),
  benchmark_df = intercept_forecast %>%
    rename(benchmark_values = forecast_values)) %>%
  rename(inflation = quantile_r2)

iar_r2 %>%
  inner_join(inflation_r2,by = c("horizon", "quantile")) %>%
  pivot_longer(-c(horizon, quantile)) %>%
  mutate(quantile = factor(quantile, levels = quantile_vec)) %>%
  ggplot(aes(x = quantile, y = value, fill = name)) +
  geom_col(position = "dodge") +
  scale_fill_discrete(labels = c("IaR","Inflation only")) +
  xlab("Quantile") + ylab(NULL) + 
  facet_wrap(~horizon, scales = "free")

```
