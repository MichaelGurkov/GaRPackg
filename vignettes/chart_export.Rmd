
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE, message = FALSE,
  warning = FALSE, comment = "#>"

)
```


```{r init_setup}

devtools::load_all()

library(GaRPackg)

setwd(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep = "\\"),
  "\\Documents\\GaRPackg\\vignettes"))

library(tidyverse)

library(cowplot)

library(broom)

library(gghighlight)

```


```{r set_params}

partitions_list = list(
  dom_macro = c(
    "private_consumption",
    "public_consumption",
    "investment",
    "unemployment"),
  ext_macro = c(
    "oecd_imp",
    "exports",
    "imports"
  ),
  dom_fin = c(
    "credit",
    "house_price",
    "ta125_close",
    "boi_rate"
  ),
  ext_fin = c(
    "rate_euro",
    "rate_us",
    "sp500",
    "eurostoxx600",
    "oil_p",
    "non_energy_p"
  )
)



horizon_list=c(1,4,8,12)

quantile_vec=c(0.05,0.25,0.5,0.75,0.95)


theme_set(theme_bw() + 
            theme(title = element_text(size = 20),
                axis.text = element_text(size = 15),
                axis.title = element_text(size = 15),
                strip.text = element_text(size = 15),
                legend.position = "bottom",
                legend.title = element_blank(),
                legend.text = element_text(size = 15)))


```

```{r load_data}

raw_df = import_from_fame_template(
  paste0(
    file.path(Sys.getenv("USERPROFILE")),
    "\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data\\Working_data\\data_fame_backup.csv"
  )
)

df = raw_df %>%
  select(date, starts_with("gdp"),
         any_of(unlist(partitions_list, use.names = FALSE))) %>%
  preprocess_df(
    vars_to_yoy = c(
      "gdp",
      "private_consumption",
      "public_consumption",
      "investment",
      "oecd_imp",
      "exports",
      "imports",
      "sp500",
      "eurostoxx600",
      "oil_p",
      "non_energy_p",
      "credit",
      "house_price",
      "ta125_close"
    ),
    vars_to_diff = c("unemployment",
                     "boi_rate",
                     "rate_euro",
                     "rate_us"),
    vars_to_4_ma = c("gdp_us",
                     "gdp_euro")
  ) %>%
  mutate(across(c("gdp_euro", "gdp_us"), ~ . / 25))



```

```{r run_analysis}

gar_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2019 Q4")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))

```

```{r out_of_sample_forecast}

dsge_forecast = import_dsge_forecasts(
  paste0(
    file.path(Sys.getenv("USERPROFILE")),
    "\\OneDrive - Bank Of Israel\\Data\\BoI\\GaR_Data\\DSGE forecasts.xlsx"
  )
) %>% 
  filter(target_var == "gdp") %>% 
  select(-target_var)

gar_forecast = get_gar_forecast(partitions_list = partitions_list,
                                vars_df = df %>% 
                                  filter(date <= as.yearqtr("2019 Q4")),
                                target_var_name = "gdp",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = 40,
                                win_type_expanding = TRUE)

intercept_forecast = get_gar_forecast(partitions_list = NULL,
                                vars_df = df %>% 
                                  filter(date <= as.yearqtr("2019 Q4")),
                                target_var_name = "gdp",
                                horizon_list = horizon_list,
                                quantile_vec = quantile_vec,
                                win_len = 40,
                                win_type_expanding = TRUE)


```


```{r import_robustness_data, eval=FALSE}

fit_df = read_rds(paste0(
  file.path(Sys.getenv("USERPROFILE"), fsep = "\\"),
  "\\OneDrive - Bank Of",
  " Israel\\Data\\BoI\\GaR_Data\\fit_df.RDS"))

```


```{r export_gdp_credit}

temp_df = df %>%
  filter(!is.na(date)) %>% 
  filter(lubridate::year(date) >= 1996 & 
           lubridate::year(date) <= 2019) %>% 
  select(all_of(c("gdp","credit"))) %>%
  add_leads_to_target_var(target_var_name = "gdp",
                          leads_vector = 4) %>%
  filter(complete.cases(.))

qreq_list = map(list("gdp","credit"), function(temp_var){

temp_qreq = rq(paste0("gdp_4","~",temp_var),
               tau = c(0.05,0.5,0.95),
               data = temp_df) %>%
  coefficients() %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  mutate(rowname = str_remove_all(rowname, "tau= ")) %>%
  rename(Quantile = rowname,
         my_int = `(Intercept)`,
         my_slope = !!sym(temp_var))

  return(temp_qreq)

})

gdp_lines = qreq_list %>% 
  pluck(1) %>% 
  pmap(function(Quantile, my_int, my_slope){
    
    y_vec = my_int + my_slope * temp_df$gdp
    
    return(tibble(!!sym(paste0("gdp_",Quantile)) := y_vec))
}) %>% 
  bind_cols()

credit_lines = qreq_list %>% 
  pluck(2) %>% 
  pmap(function(Quantile, my_int, my_slope){
    
    y_vec = my_int + my_slope * temp_df$gdp
    
    return(tibble(!!sym(paste0("credit_",Quantile)) := y_vec))
}) %>% 
  bind_cols()
  
  
plot_df = list(temp_df, gdp_lines, credit_lines) %>% 
  bind_cols()


plot_df %>% 
  write_csv(paste0(Sys.getenv("USERPROFILE"),
                   "\\OneDrive - Bank Of Israel\\research",
                   "\\gar\\credit_gdp_plot_data.csv"))


rm(temp_df, qreq_list, gdp_lines, credit_lines, plot_df)

```



```{r export_plot_pca_timeseries}


gar_analysis %>%
  extract_pca_timeseries_from_gar_model() %>%
  filter(date >= as.yearqtr("1996 Q1")) %>% 
  write_csv(paste0(Sys.getenv("USERPROFILE"),
                   "\\OneDrive - Bank Of Israel\\research",
                   "\\gar\\pca_timeseries_plot_data.csv"))

```

```{r fin_cycle_plot}

gar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  select(-c(low,high)) %>% 
  filter(!partition == "Intercept") %>% 
  write_csv(paste0(Sys.getenv("USERPROFILE"),
                   "\\OneDrive - Bank Of Israel\\research",
                   "\\gar\\quantile_reg_coeffs_plot_data.csv"))

```


```{r plot_skewness_1_quarter}

gar_analysis %>%
  calculate_skew_and_iqr() %>%
  filter(horizon == 1) %>%
  select(date, skew) %>%
  ggplot(aes(x = date, y = skew)) +
  geom_line() +
  geom_hline(yintercept = c(-0.5,0.5), linetype = "dashed",
             color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  labs(x = "", y = "", title = "Quartile Skewness 1Q Ahead",
       caption = "Note: the dashed lines represent Â± 2 standard error estimates") + 
  theme(plot.caption = element_text(hjust = 0.5))
  

```


```{r skewness_figure, out.height="85%", eval=FALSE}

knitr::include_graphics("Figures/Risk_assymetry_h1.png")


```


```{r growth_dist}

growth_dist_plot = df %>%
  select(date, starts_with("gdp")) %>%
  filter(date <= as.yearqtr("2019 Q4")) %>%
  pivot_longer(-date) %>%
  filter(complete.cases(.)) %>%
  mutate(name = factor(
    name,
    levels = c("gdp", "gdp_us", "gdp_euro"),
    labels = c("Israel", "US", "Euro")
  )) %>%
  group_by(name) %>%
  mutate(value = scale(value, scale = FALSE)) %>%
  ungroup %>%
  ggplot(aes(x = value, fill = name)) +
  geom_histogram(position = "dodge") +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c(
    "Israel" = "skyblue",
    "US" = "darkgray",
    "Euro" = "lightpink"
  ))   +
  xlab(NULL) + ylab(NULL) + 
  ggtitle("Centered GDP growth \n (year on year) distribution") + 
  theme(
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank(),
  legend.position = "none"
)

growth_timeseries_plot = df %>%
  select(date, starts_with("gdp")) %>%
  filter(date <= as.yearqtr("2019 Q4")) %>%
  pivot_longer(-date) %>%
  filter(complete.cases(.)) %>%
  mutate(name = factor(
    name,
    levels = c("gdp", "gdp_us", "gdp_euro"),
    labels = c("Israel", "US", "Euro")
  )) %>%
  ggplot(aes(x = date, y = value, color = name)) +
  geom_line() +
  xlab(NULL) + ylab(NULL) + ggtitle("GDP growth (year on year)") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_manual(values = c(
    "Israel" = "skyblue",
    "US" = "darkgray",
    "Euro" = "lightpink"
  ))   +
  theme(legend.position = "none")


plot_list = list(growth_dist_plot, growth_timeseries_plot)

legend_p = get_legend(
  plot_list[[1]] + theme(legend.position = "bottom",
                         legend.title = element_blank()))

plot_grid(plot_grid(plotlist = plot_list,ncol = 2),
          nrow = 2,
          legend_p, rel_heights = c(1,0.2))


```


```{r plot_gdp_growth, eval=FALSE}

df %>%
  select(date,gdp_us, gdp_euro, gdp) %>%
  filter(date <= as.yearqtr("2019 Q4")) %>% 
  # mutate(across(starts_with("gdp"), ~scale(., scale = FALSE))) %>% 
  rename(US = gdp_us, Euro = gdp_euro, Israel = gdp) %>%
  pivot_longer(-date) %>%
  filter(complete.cases(.)) %>%
  ggplot(aes(x = value, fill = name)) +
  geom_density(alpha = 0.3) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  xlab(NULL) + ylab(NULL) + ggtitle("YoY GDP growth distribution")

```



```{r plot_factor_decomposition, eval=FALSE}


gar_analysis %>%
  extract_factor_contribution_from_gar_model() %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  select(-intercept) %>%
  pivot_longer(-c("date","horizon")) %>%
  mutate(name = factor(name,
                       levels = c("dom_macro","dom_fin","ext_macro","ext_fin"),
                       labels =  c("Dom. Macro","Dom. Fin. Cond.",
                                   "External Macro","External Fin. Cond."))) %>%
  ggplot(aes(x = date, y = value, fill = name)) +
  geom_col() +
  facet_wrap(~horizon, scales = "free") +
  xlab(NULL) + ylab(NULL) +
  ggtitle(paste("Factors contribution to the",
                 "GaR forecast \n (5th percentile)")) +
  scale_fill_viridis_d(option = "plasma")



```


```{r factors_figure, out.height="85%"}

knitr::include_graphics("Figures/GaR_factor_all.png")


```


```{r plot_median_iqr_scatter, eval=FALSE}

gar_analysis %>%
  calculate_skew_and_iqr() %>%
  inner_join(gar_analysis$fitted_df %>%
               filter(quantile == "0.5") %>%
               select(-quantile), by = c("date","horizon")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = iqr, y = fitted_values)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Dispersion") + ylab("Median") +
  facet_wrap(~horizon, scales = "free") +
  theme(axis.text = element_text(size = 8))


```


```{r med_variance_figure, out.height="85%"}

knitr::include_graphics("Figures/fig_MedianVarCorr.png")


```


```{r}

knitr::include_graphics("Figures/fig_bootstrap_skewness.png")

```


```{r}

knitr::include_graphics("Figures/fig_bootstrap_FinCoefs.png")

```



```{r}

knitr::include_graphics("Figures/fig_bootstrap_MedianVarCorr.png")

```


```{r pit_score, eval=FALSE}

gar_pit = quantile_pit_score(
  forecast_df = gar_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = select(df, actual_values = gdp, date)
) %>%
  rename(gar = pit)

intercept_pit = quantile_pit_score(
  forecast_df = intercept_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = select(df, actual_values = gdp, date)
) %>%
  rename(intercept = pit)

dsge_pit = quantile_pit_score(
  forecast_df = dsge_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = select(df, actual_values = gdp, date)
) %>%
  rename(dsge = pit)

list(gar_pit, intercept_pit, dsge_pit) %>%
  reduce(inner_join, by = c("quantile", "horizon")) %>%
  pivot_longer(-c("quantile", "horizon")) %>%
  mutate(horizon = factor(horizon, levels = c(1, 4, 8, 12))) %>%
  mutate(quantile = as.numeric(quantile)) %>%
  ggplot(aes(
    x = quantile,
    y = value,
    color = name,
    group = name
  )) +
  geom_line(width = 0.5) +
  geom_abline(
    slope = 1,
    intercept = 0,
    color = "black",
    linetype = "dashed"
  ) +
  scale_fill_discrete(labels = c("DSGE","GaR")) +
  facet_wrap(~horizon) +
  xlab("Quantile") + ylab(NULL)



```


```{r pit_figure}

knitr::include_graphics("Figures/PIT.png")


```


```{r plot_r2_score, eval=FALSE}

gar_r2 = quantile_r2_score(
  forecast_df = gar_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25),
  actual_df = df %>% 
    filter(date) < as.yearqtr("2019 Q4") %>% 
    select(date, actual_values = gdp),
  benchmark_df = intercept_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25) %>%
    rename(benchmark_values = forecast_values)
) %>%
  rename(gar_r2 = quantile_r2)

dsge_r2 = quantile_r2_score(
  forecast_df = dsge_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25) %>%
    rename(forecast_values = forecast),
  actual_df = df %>% 
    filter(date) < as.yearqtr("2019 Q4") %>% 
    select(date, actual_values = gdp),
  benchmark_df = intercept_forecast %>%
    mutate(date = date + as.numeric(horizon) * 0.25) %>%
    rename(benchmark_values = forecast_values)
  ) %>%
  rename(dsge_r2 = quantile_r2)

gar_r2 %>%
  inner_join(dsge_r2,by = c("horizon", "quantile")) %>%
  pivot_longer(-c(horizon, quantile)) %>%
  mutate(quantile = factor(quantile, levels = quantile_vec)) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = quantile, y = value, fill = name)) +
  geom_col(position = "dodge") +
  scale_fill_discrete(labels = c("DSGE","GaR")) +
  facet_wrap(~horizon) +
  xlab("Quantile") + ylab(NULL)

```


```{r r2_figure, out.height="85%"}

knitr::include_graphics("Figures/R2.png")


```



```{r left_tail}

current_analysis = run_GaR_analysis(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2021 Q1")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))


current_analysis$fitted_df %>%
  filter(horizon %in% c(1, 4)) %>%
  filter(quantile == "0.05") %>%
  ggplot(aes(x = date, y = fitted_values, color = horizon)) +
  geom_line() + 
  ylab(NULL) + xlab(NULL) +
  scale_y_continuous(labels = scales::percent_format()) +
  ggtitle("Forecast of 5th Percentile, 1Q and 4Q Ahead")

```


```{r fan_chart_2019_4}

fan_forecast_df = get_gar_forecast(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2019 Q4")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))

fan_forecast_df %>% 
  plot_fan_chart(actual_df = df %>% 
                   select(date, gdp),
                 fan_chart_date = as.yearqtr("2019 Q4")) + 
  ggtitle("Fan chart at 2019 Q4")



```


```{r fan_chart_2020_4}

fan_forecast_df = get_gar_forecast(
  partitions_list = partitions_list,
  vars_df = df %>% 
  filter(date <= as.yearqtr("2020 Q4")),
  target_var_name = "gdp",
  horizon_list = horizon_list,
  quantile_vec = quantile_vec,
  pca.align.list = list(dom_macro = "private_consumption",
                        ext_macro = "exports",
                        dom_fin = "credit",
                        ext_fin = "sp500"))

fan_forecast_df %>% 
  plot_fan_chart(actual_df = df %>% 
                   select(date, gdp),
                 fan_chart_date = as.yearqtr("2020 Q4")) + 
  ggtitle("Fan chart at 2020 Q4")



```


```{r plot_events_plot}

recessions = read.csv(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
  "\\OneDrive - Bank Of Israel\\",
  "Data\\BoI\\GaR_Data","\\recessions.csv")) %>%
  mutate(across(c(Start, End), ~as.yearqtr(.)))

events = read.csv(paste0(
  file.path(Sys.getenv("USERPROFILE"),fsep="\\"),
  "\\OneDrive - Bank Of Israel\\",
  "Data\\BoI\\GaR_Data","\\events.csv")) %>%
  mutate(across(c(Start, End), ~as.yearqtr(.)))


gar_analysis$fitted_df %>%
  filter(horizon %in% c(1, 12)) %>%
  filter(quantile == "0.05") %>%
  ggplot() +
  ylim(c(-0.12, 0.08)) +
  geom_point(aes(x = date, y = fitted_values, color = horizon)) +
  geom_line(aes(x = date, y = fitted_values, color = horizon)) +
  geom_rect(data = recessions,mapping = aes(xmin = Start,xmax = End,
                                            ymin = -Inf,ymax = Inf),
            fill = "lightblue", alpha = 0.5) +
  ylab(NULL) + xlab(NULL) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_manual(values = c("red","magenta")) + 
  ggtitle("Forecast of 5th Percentile, 1Q and 12Q Ahead") +
  geom_point(data = . %>% filter(date %in% events$Start),
             aes(x = date, y = fitted_values),color = "blue") +
  geom_segment(data = . %>%filter(date %in% events$Start),
               aes(x = date,y = c(0.0745, 0.0745, -0.0745,
                                  0.0745, +0.0745, -0.0745),
                   xend = date,
                   yend = fitted_values),
               arrow = arrow(length = unit(0.1, "cm")), color = "blue") +
  geom_text(data = events,mapping = aes(x = Start + 1,
                                        y = c(0.08, 0.08, -0.08),
                                        label = Event),color = "blue") +
  labs(caption = paste0(
    "Notes: Shaded areas depict US and Euro",
    " recessions (NBER and CEPR recessions)")) +
  theme(plot.caption = element_text(hjust = 0))


```


```{r events_figure, out.height="85%", eval=FALSE}

knitr::include_graphics("Figures/events_plot.png")


```


```{r dom_macro_plot, fig.height=6.5}


gar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(partition %in% c("dom_macro", "ext_macro")) %>%
  mutate(partition = recode(partition,
                            "dom_macro" = "Dom. Macro", "ext_macro" = "Ext. Macro")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = quantile, y = coeff, fill = significant)) +
  geom_col() +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_grid(cols = vars(horizon), rows = vars(partition), scales = "free") +
  xlab("Quantile") + ylab(NULL) + 
  labs(caption = paste0("Notes: Each column shows the estimated coefficients ",
                        "from the quantile regression at a specific forecast horizon. ",
                        "\n Blue bars mark coefficients that are significant at 10%",
                        "(see Koenker, 1994)"),
       title = "Sample: 1996Q1-2019Q4") + 
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12))




```




```{r, out.height="85%"}

knitr::include_graphics("Figures/fig_bootstrap_5per.png")

```



```{r plot_pc_loadings}

gar_analysis %>%
  extract_pca_loadings_from_gar_model() %>%
  mutate(partition = factor(
    partition,
    levels = c("dom_fin", "dom_macro","ext_fin",  "ext_macro"),
    labels = c("Dom. Fin. Cond", "Dom Macro", "Ext. Fin. Cond",  "Ext Macro"))) %>%
  mutate(rowname = str_to_title(rowname)) %>% 
  mutate(rowname = str_replace_all(rowname,"_"," ")) %>% 
  ggplot(aes(x = rowname, y = coeff)) +
  geom_col(width = 0.5) +
  facet_wrap( ~ partition, scales = "free") +
  theme(axis.text.x = element_text(size = 13)) +
  coord_flip() +
  xlab(NULL) + ylab(NULL)

```



```{r coeff_panel_plot, fig.height=7}

gar_analysis %>%
  extract_coeffs_from_gar_model() %>%
  filter(!partition == "Intercept") %>%
  mutate(partition = recode(partition,
                            "dom_macro" = "Dom. Macro",
                            "ext_macro" = "Ext. Macro",
                            "dom_fin" = "Dom. Fin. Cond.",
                            "ext_fin" = "Ext. Fin. Cond.")) %>%
  mutate(horizon = factor(horizon, levels = c(1,4,8,12))) %>%
  ggplot(aes(x = quantile, y = coeff, fill = significant)) +
  geom_col() +
  scale_fill_manual(values = c("significant" = "lightblue",
                               "non_significant" = "gray"),
                    labels = c("Significant", "Non significant")) +
  facet_grid(cols = vars(horizon), rows = vars(partition), scales = "free") +
  xlab("Quantile") + ylab(NULL) + 
  theme(plot.caption = element_text(size = 10, hjust = 0.5),
        axis.text.x = element_text(size = 12),strip.text.y = element_text(size = 14))


```

